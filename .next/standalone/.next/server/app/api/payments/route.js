"use strict";(()=>{var e={};e.id=7649,e.ids=[7649],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},84219:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>S,patchFetch:()=>h,requestAsyncStorage:()=>I,routeModule:()=>w,serverHooks:()=>D,staticGenerationAsyncStorage:()=>y});var a={};n.r(a),n.d(a,{GET:()=>g,POST:()=>b,dynamic:()=>l,runtime:()=>f});var r=n(49303),o=n(88716),i=n(60670),s=n(87070),c=n(9487),u=n(40259),d=n(90455),m=n(92906);let l="force-dynamic",f="nodejs";function p(e){e.data.members||=[],e.data.collectors||=[],e.data.payments||=[],e.data.movements||=[]}async function g(e){if(!await (0,d.mk)(e,["admin","caja","consulta"]))return s.NextResponse.json({ok:!1},{status:401});try{let{searchParams:t}=new URL(e.url),n=t.get("memberId"),a=await (0,c.getDb)();p(a);let r=a.data.payments;n&&(r=r.filter(e=>e.memberId===n));let o=r.map(e=>{let t=a.data.members.find(t=>t.id===e.memberId),n=e.cobradorId?a.data.collectors.find(t=>t.id===e.cobradorId):null;return{...e,memberName:t?`${t.nombres} ${t.apellidos}`:"Socio no encontrado",memberCode:t?.codigo||"N/A",cobradorName:n?`${n.nombres} ${n.apellidos}`:null}});return o.sort((e,t)=>new Date(t.fecha).getTime()-new Date(e.fecha).getTime()),s.NextResponse.json(o)}catch(e){return console.error("Error loading payments:",e),s.NextResponse.json({ok:!1,msg:"Error al cargar pagos"},{status:500})}}async function b(e){if(!await (0,d.mk)(e,["admin","caja"]))return s.NextResponse.json({ok:!1},{status:401});try{let t=await (0,c.getDb)();p(t);let n=await e.json();if(!t.data.members.find(e=>String(e.id)===String(n.memberId)))return s.NextResponse.json({ok:!1,msg:"Socio no encontrado"},{status:400});if(n.cobradorId&&!t.data.collectors.find(e=>String(e.id)===String(n.cobradorId)))return s.NextResponse.json({ok:!1,msg:"Cobrador no encontrado"},{status:400});let a=await (0,c.nextPaymentId)(),r=n.fecha||(0,m.LJ)(),o=r;/^\d{4}-\d{2}-\d{2}$/.test(r)&&(o=`${r}T12:00:00.000Z`);let i=0;if(n.cobradorId){let e=t.data.collectors.find(e=>e.id===String(n.cobradorId));if(e){if("PROFESOR"===e.tipoCobrador)i=.5*Number(n.monto);else if("EXTERNO"===e.tipoCobrador){let a=t.data.services.find(e=>n.concepto&&n.concepto.toLowerCase().includes(e.nombre.toLowerCase())),r=0;a&&a.comisionCobrador?r=a.comisionCobrador:e.comisionPorDefecto&&(r=e.comisionPorDefecto),i=Number(n.monto)*r/100}}}let d={id:a,memberId:String(n.memberId),fecha:o,monto:Number(n.monto)||0,concepto:n.concepto||"",formaPago:n.formaPago||"efectivo",cobradorId:n.cobradorId?String(n.cobradorId):"",comisionCobrador:Math.round(100*i)/100,comisionPagada:!1,observaciones:n.observaciones||"",numeroRecibo:n.numeroRecibo||"",allocations:Array.isArray(n.allocations)?n.allocations:[]};if(!(d.monto>0)||!d.concepto)return s.NextResponse.json({ok:!1,msg:"Monto y Concepto son obligatorios"},{status:400});t.data.payments.push(d);let l=d.concepto&&String(d.concepto).trim()||`Pago${d.formaPago?" "+d.formaPago:""}${d.numeroRecibo?` • Recibo ${d.numeroRecibo}`:""}`,f={id:(0,u.x0)(),memberId:d.memberId,fecha:d.fecha,concepto:l,tipo:"CREDIT",monto:d.monto,origen:"PAGO",refId:String(d.id),allocations:[]};if(t.data.movements.push(f),Array.isArray(d.allocations)&&d.allocations.length>0){for(let e of d.allocations){let n=t.data.movements.find(t=>String(t.id)===String(e.debitId));if(!n)return s.NextResponse.json({ok:!1,msg:`D\xe9bito ${e.debitId} no existe`},{status:400});if(String(n.memberId)!==String(d.memberId))return s.NextResponse.json({ok:!1,msg:"D\xe9bito inv\xe1lido para este socio"},{status:400});let a=function(e){let t=String(e||"").toUpperCase();return"DEBE"===t?"DEBIT":"HABER"===t?"CREDIT":t}(n.tipo);if("DEBIT"!==a)return s.NextResponse.json({ok:!1,msg:"Solo se puede asignar a d\xe9bitos"},{status:400});let r=Number(e.amount)||0;if(!(r>0))continue;let o=Number(n.paidAmount||0),i=Math.max(0,Number(n.monto||0)-o),c=Math.min(r,i);c<=0||(n.paidAmount=Math.round((o+c)*100)/100,n.allocations||=[],n.allocations.push({paymentId:d.id,creditMovementId:f.id,amount:c}),function(e){let t=Number(e.paidAmount||0),n=Number(e.monto||0),a="PENDIENTE";a=t<=0?"PENDIENTE":t+1e-4>=n?"CANCELADO":"PARCIAL",e.status=a}(n),f.allocations.push({debitId:String(n.id),amount:c}))}d.allocations=[...f.allocations]}for(let e of(t.data.refinancings||[]).filter(e=>e.memberId===d.memberId&&"ACTIVA"===e.status)){let n=!1;for(let a of e.schedule){let r=null;if(a.debitMovementId&&(r=t.data.movements.find(e=>e.id===a.debitMovementId)),!r&&(r=t.data.movements.find(t=>t.refinancingId===e.id&&t.installmentNumber===a.number&&"DEBIT"===t.tipo))&&!a.debitMovementId&&(a.debitMovementId=r.id,n=!0),!r)continue;let o=Number(r.paidAmount||0),i=Number(r.monto||0),s="PENDIENTE";s=o<=0?"PENDIENTE":o+1e-4>=i?"PAGADA":"PARCIAL",(a.paidAmount!==o||a.status!==s)&&(a.paidAmount=o,a.status=s,n=!0)}n&&(e.updatedAt=new Date().toISOString())}t.data.memberSubscriptions=t.data.memberSubscriptions||[],t.data.services=t.data.services||[];let g=d.allocations?.map(e=>e.debitId)||[];for(let e of t.data.movements.filter(e=>g.includes(e.id))){let n=null;if(e.serviceId)n=e.serviceId;else if(e.concepto){let a=t.data.services.find(t=>e.concepto.toLowerCase().includes(t.nombre.toLowerCase()));a&&(n=a.id)}if(n)for(let e of t.data.memberSubscriptions.filter(e=>e.memberId===d.memberId&&e.serviceId===n&&"ACTIVE"===e.status)){let t;let a=e.nextChargeDate?new Date(e.nextChargeDate):new Date,r=new Date(d.fecha),o=e.periodicity;if("MONTHLY"===o||"MENSUAL"===o)r>=a?(t=new Date(r)).setMonth(t.getMonth()+1):(t=new Date(a)).setMonth(t.getMonth()+1);else if("ANNUAL"===o||"ANUAL"===o)r>=a?(t=new Date(r)).setFullYear(t.getFullYear()+1):(t=new Date(a)).setFullYear(t.getFullYear()+1);else{if("DAILY"!==o&&"DIARIO"!==o)continue;let n=e.cadenceDays||1;r>=a?(t=new Date(r)).setDate(t.getDate()+n):(t=new Date(a)).setDate(t.getDate()+n)}e.nextChargeDate=t.toISOString().slice(0,10),e.updatedAt=new Date().toISOString(),console.log(`✅ Suscripci\xf3n actualizada: ${n} - Pr\xf3ximo cobro: ${e.nextChargeDate}`)}}return await t.write(),s.NextResponse.json(d,{status:201})}catch(e){return console.error("Error creating payment:",e),s.NextResponse.json({ok:!1,msg:"Error al crear pago"},{status:500})}}let w=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payments/route",pathname:"/api/payments",filename:"route",bundlePath:"app/api/payments/route"},resolvedPagePath:"C:\\Garden\\app\\api\\payments\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:I,staticGenerationAsyncStorage:y,serverHooks:D}=w,S="/api/payments/route";function h(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:y})}},90455:(e,t,n)=>{n.d(t,{B$:()=>u,hm:()=>d,mk:()=>l,zB:()=>m});var a=n(41482),r=n.n(a),o=n(42023),i=n.n(o),s=n(9487);let c=process.env.JWT_SECRET||"dev-secret",u="gcp_token";async function d(){return 0===(await (0,s.getDb)()).data.users.length}async function m(e,t){let n=await (0,s.getDb)();if(0===n.data.users.length)return{token:r().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},c,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=n.data.users.find(t=>t.email===e);return a&&await i().compare(t,a.passwordHash)?{token:r().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},c,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let n=e.cookies.get(u)?.value;if(!n)return null;try{let e=r().verify(n,c);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,n)=>{let a;n.r(t),n.d(t,{addDays:()=>P,calculateMemberDebt:()=>C,calculatePaidAmountForDebit:()=>N,computeQuote:()=>A,convertNoSocioToSocio:()=>m,endOfMonth:()=>M,formatCurrency:()=>v,getDb:()=>u,getMemberStatus:()=>E,hasReservationConflict:()=>x,nextCollectorCode:()=>l,nextCommissionId:()=>b,nextFamilyId:()=>p,nextFinancingId:()=>g,nextMemberCode:()=>d,nextMovementId:()=>S,nextPaymentId:()=>f,nextRefinancingId:()=>h,nextReservationId:()=>I,nextReservationPaymentId:()=>y,nextResourceId:()=>w,nextSubscriptionId:()=>D,startOfMonth:()=>q,toISODate:()=>R,yyyymm:()=>T});var r=n(26411),o=n(92048),i=n.n(o),s=n(55315),c=n.n(s);function u(){if(!a){let e=function(){let e=c().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();a=(0,r.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function d(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function m(e){let t=await u(),n=t.data.members.findIndex(t=>t.id===e);if(-1===n)throw Error("Member not found");let a=t.data.members[n];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let r=await d();return t.data.members[n]={...a,codigo:r,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[n]}async function l(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function b(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function w(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function I(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function y(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function D(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function h(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function A(e,t,n,a,r=0){let o=e.data.resources.find(e=>e.id===t),i=o?.precioBaseHora??0,s=new Date(n).getTime(),c=Math.max(1,Math.ceil((new Date(a).getTime()-s)/36e5)),u=i*c;return r>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function x(e,t,n,a,r){let o=new Date(n).getTime(),i=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==r&&Math.max(new Date(e.start).getTime(),o)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function v(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function N(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let n=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(n+=Number(t.amount||0));return n}function C(e,t){let a=0;for(let n of t)if(n.memberId===e.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let e=N(n,t),r=n.monto-e;r>0&&(a+=r)}let r=n(9487),o=0;try{for(let t of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))o+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=o)}function E(e,t){return C(e,t)>0?"ATRASADO":"AL_DIA"}function R(e){let t="string"==typeof e?new Date(e):e,n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}function P(e,t){let n=new Date("string"==typeof e?e:e.getTime());return n.setDate(n.getDate()+t),n}function q(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function T(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},92906:(e,t,n)=>{n.d(t,{LJ:()=>o,tF:()=>r});let a={name:"America/Asuncion"};function r(){let e=new Date,t=Object.fromEntries(new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).formatToParts(e).map(e=>[e.type,e.value]));return new Date(parseInt(t.year),parseInt(t.month)-1,parseInt(t.day),parseInt(t.hour),parseInt(t.minute),parseInt(t.second))}function o(e){if(e){let t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${a}`}{let e=new Date;return new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit"}).format(e)}}},40259:(e,t,n)=>{let a,r;n.d(t,{x0:()=>i});let o=require("node:crypto");function i(e=21){var t;t=e-=0,!a||a.length<t?(a=Buffer.allocUnsafe(128*t),o.webcrypto.getRandomValues(a),r=0):r+t>a.length&&(o.webcrypto.getRandomValues(a),r=0),r+=t;let n="";for(let t=r-e;t<r;t++)n+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&a[t]];return n}}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>n(84219));module.exports=a})();