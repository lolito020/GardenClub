"use strict";(()=>{var e={};e.id=8185,e.ids=[8185],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},59873:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>b,staticGenerationAsyncStorage:()=>g});var n={};o.r(n),o.d(n,{GET:()=>l,dynamic:()=>u,runtime:()=>m});var a=o(49303),r=o(88716),i=o(60670),s=o(87070),c=o(9487),d=o(90455);let u="force-dynamic",m="nodejs";async function l(e,{params:t}){try{if(!await (0,d.mk)(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let o=await (0,c.getDb)(),n=t.id,a=o.data.collectors.find(e=>e.id===n);if(!a)return s.NextResponse.json({error:"Cobrador no encontrado"},{status:404});let r=o.data.payments.filter(e=>e.cobradorId===n).map(e=>{if("number"==typeof e.comisionCobrador&&e.comisionCobrador>0)return{...e,computedComision:e.comisionCobrador,comisionPagada:!!e.comisionPagada};let t=o.data.movements.find(t=>t.refId===e.id&&"CREDIT"===t.tipo),n=null;if(t&&Array.isArray(t.allocations)&&t.allocations.length>0){let e=t.allocations[0],a=e.debitId||e.debitMovementId||null;if(a){let e=o.data.movements.find(e=>e.id===a);e&&(n=e.refId||null)}}let r=0;if("PROFESOR"===a.tipoCobrador)r=50;else if("CLUB"===a.tipoCobrador)r=0;else{let e=o.data.services.find(e=>e.id===n);r=e&&"number"==typeof e.comisionCobrador?e.comisionCobrador:a.comisionPorDefecto||0}let i=Math.round(e.monto*r/100);return{...e,computedComision:i,comisionPagada:!!e.comisionPagada}}).filter(e=>e.computedComision&&e.computedComision>0),i=r.filter(e=>!e.comisionPagada),u=r.filter(e=>e.comisionPagada),m=r.reduce((e,t)=>e+(t.computedComision||0),0),l=i.reduce((e,t)=>e+(t.computedComision||0),0),p=u.reduce((e,t)=>e+(t.computedComision||0),0),f=i.map(e=>{let t=o.data.members.find(t=>t.id===e.memberId);return{id:e.id,fecha:e.fecha,monto:e.monto,comisionCobrador:e.computedComision||0,concepto:e.concepto,numeroRecibo:e.numeroRecibo||"",formaPago:e.formaPago,socio:t?{id:t.id,codigo:t.codigo,nombres:t.nombres,apellidos:t.apellidos}:null}}),g=u.map(e=>{let t=o.data.members.find(t=>t.id===e.memberId);return{id:e.id,fecha:e.fecha,monto:e.monto,comisionCobrador:e.computedComision||0,concepto:e.concepto,numeroRecibo:e.numeroRecibo||"",formaPago:e.formaPago,socio:t?{id:t.id,codigo:t.codigo,nombres:t.nombres,apellidos:t.apellidos}:null}}),b=o.data.commissionPayments.filter(e=>e.cobradorId===n).sort((e,t)=>new Date(t.fecha).getTime()-new Date(e.fecha).getTime()).map(e=>({id:e.id,fecha:e.fecha,monto:e.monto,concepto:e.concepto,formaPago:e.formaPago,periodo:e.periodo,numeroRecibo:e.numeroRecibo||"",observaciones:e.observaciones||"",cantidadPagos:e.paymentIds?.length||0})),w=new Date,y=[];for(let e=5;e>=0;e--){let t=new Date(w.getFullYear(),w.getMonth()-e,1),o=t.toISOString().slice(0,7),n=r.filter(e=>e.fecha&&e.fecha.startsWith(o)),a=n.reduce((e,t)=>e+(t.computedComision||0),0),i=b.filter(e=>e.periodo===o).reduce((e,t)=>e+t.monto,0);y.push({periodo:o,mes:t.toLocaleDateString("es-ES",{month:"long",year:"numeric"}),comisionGenerada:a,comisionLiquidada:i,cantidadPagos:n.length})}let h={cobrador:{id:a.id,codigo:a.codigo,nombres:a.nombres,apellidos:a.apellidos,tipoCobrador:a.tipoCobrador,comisionPorDefecto:a.comisionPorDefecto,formaPago:a.formaPago,cuentaBanco:a.cuentaBanco},totales:{comisionesGeneradas:m,comisionesPendientes:l,comisionesPagadas:p,generados:m,pendientes:l,pagados:p,cantidadPagosPendientes:i.length,cantidadPagosPagados:u.length,cantidadLiquidaciones:b.length},pagosPendientes:f,pagosPagados:g,liquidaciones:b.slice(0,10),estadisticasMensuales:y};return s.NextResponse.json(h)}catch(e){return console.error("Error al obtener comisiones:",e),s.NextResponse.json({error:"Error al obtener comisiones"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/collectors/[id]/commissions/route",pathname:"/api/collectors/[id]/commissions",filename:"route",bundlePath:"app/api/collectors/[id]/commissions/route"},resolvedPagePath:"C:\\Garden\\app\\api\\collectors\\[id]\\commissions\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:b}=p,w="/api/collectors/[id]/commissions/route";function y(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:g})}},90455:(e,t,o)=>{o.d(t,{B$:()=>d,hm:()=>u,mk:()=>l,zB:()=>m});var n=o(41482),a=o.n(n),r=o(42023),i=o.n(r),s=o(9487);let c=process.env.JWT_SECRET||"dev-secret",d="gcp_token";async function u(){return 0===(await (0,s.getDb)()).data.users.length}async function m(e,t){let o=await (0,s.getDb)();if(0===o.data.users.length)return{token:a().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},c,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let n=o.data.users.find(t=>t.email===e);return n&&await i().compare(t,n.passwordHash)?{token:a().sign({sub:n.id,rol:n.rol,nombre:n.nombre,email:n.email},c,{expiresIn:"8h"}),user:{email:n.email,rol:n.rol,nombre:n.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let o=e.cookies.get(d)?.value;if(!o)return null;try{let e=a().verify(o,c);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,o)=>{let n;o.r(t),o.d(t,{addDays:()=>M,calculateMemberDebt:()=>I,calculatePaidAmountForDebit:()=>x,computeQuote:()=>C,convertNoSocioToSocio:()=>m,endOfMonth:()=>O,formatCurrency:()=>v,getDb:()=>d,getMemberStatus:()=>A,hasReservationConflict:()=>q,nextCollectorCode:()=>l,nextCommissionId:()=>b,nextFamilyId:()=>f,nextFinancingId:()=>g,nextMemberCode:()=>u,nextMovementId:()=>P,nextPaymentId:()=>p,nextRefinancingId:()=>D,nextReservationId:()=>y,nextReservationPaymentId:()=>h,nextResourceId:()=>w,nextSubscriptionId:()=>S,startOfMonth:()=>E,toISODate:()=>R,yyyymm:()=>T});var a=o(26411),r=o(92048),i=o.n(r),s=o(55315),c=o.n(s);function d(){if(!n){let e=function(){let e=c().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();n=(0,a.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function u(){let e=await d();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function m(e){let t=await d(),o=t.data.members.findIndex(t=>t.id===e);if(-1===o)throw Error("Member not found");let n=t.data.members[o];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let a=await u();return t.data.members[o]={...n,codigo:a,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[o]}async function l(){let e=await d();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function p(){let e=await d();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function f(){let e=await d();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await d();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function b(){let e=await d();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function w(){let e=await d();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function y(){let e=await d();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function h(){let e=await d();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function S(){let e=await d();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function P(){let e=await d();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function D(){let e=await d();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function C(e,t,o,n,a=0){let r=e.data.resources.find(e=>e.id===t),i=r?.precioBaseHora??0,s=new Date(o).getTime(),c=Math.max(1,Math.ceil((new Date(n).getTime()-s)/36e5)),d=i*c;return a>100&&(d=Math.round(1.05*d)),{horas:c,monto:d}}function q(e,t,o,n,a){let r=new Date(o).getTime(),i=new Date(n).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==a&&Math.max(new Date(e.start).getTime(),r)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function v(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function x(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let o=0;for(let n of t)if(n.allocations&&Array.isArray(n.allocations))for(let t of n.allocations)t.debitId===e.id&&(o+=Number(t.amount||0));return o}function I(e,t){let n=0;for(let o of t)if(o.memberId===e.id&&"DEBIT"===o.tipo){if("REFINANCIADO"===o.status||"CANCELADO"===o.status)continue;let e=x(o,t),a=o.monto-e;a>0&&(n+=a)}let a=o(9487),r=0;try{for(let t of(a.getDb&&"function"==typeof a.getDb&&a.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))r+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,n-=r)}function A(e,t){return I(e,t)>0?"ATRASADO":"AL_DIA"}function R(e){let t="string"==typeof e?new Date(e):e,o=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${o}-${n}-${a}`}function M(e,t){let o=new Date("string"==typeof e?e:e.getTime());return o.setDate(o.getDate()+t),o}function E(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function O(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function T(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,4565],()=>o(59873));module.exports=n})();