"use strict";(()=>{var t={};t.id=7766,t.ids=[7766],t.modules={20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:t=>{t.exports=require("fs")},55315:t=>{t.exports=require("path")},87561:t=>{t.exports=require("node:fs")},93977:t=>{t.exports=require("node:fs/promises")},49411:t=>{t.exports=require("node:path")},41041:t=>{t.exports=require("node:url")},21667:(t,e,n)=>{n.r(e),n.d(e,{originalPathname:()=>p,patchFetch:()=>w,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var a={};n.r(a),n.d(a,{POST:()=>u});var r=n(49303),i=n(88716),s=n(60670),o=n(87070),c=n(9487);async function u(t){try{let{memberId:e,debitIds:n,principal:a,installments:r,downPaymentPercent:i,downPaymentAmount:s,startDueDate:u,observations:d}=await t.json();if(!e||!n||!n.length||!a)return o.NextResponse.json({error:"Faltan par\xe1metros requeridos"},{status:400});let l=await (0,c.getDb)(),m=`ref_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,f=new Date().toISOString(),p=a-s,w=Math.round(p/r),h=[],g=new Date(u);for(let t=1;t<=r;t++){let e=t===r?p-w*(r-1):w;h.push({number:t,amount:e,dueDate:g.toISOString().split("T")[0],status:"PENDIENTE"}),g=function(t,e){let n=new Date(t);return n.setMonth(n.getMonth()+1),n}(g,0)}let y=[];for(let t of n){let e=l.data.movements.find(e=>e.id===t);e&&y.push({id:e.id,monto:e.monto,paidAmount:e.paidAmount||0,vencimiento:e.vencimiento,concepto:e.concepto,fecha:e.fecha})}let S={id:m,memberId:e,originalDebitIds:n,originalDebitsSnapshot:y,principal:a,downPaymentPercent:i,downPaymentAmount:s,installments:r,installmentAmount:w,startDueDate:u,schedule:h,status:"ACTIVA",approvalRequired:!1,sentToBoard:!1,observations:d||"",auditTrail:[{timestamp:f,action:"CREATED",userId:"system",details:`Refinanciaci\xf3n creada con ${r} cuotas`}],executedAt:f,createdAt:f,updatedAt:f,createdBy:"system"};for(let t of n){let e=l.data.movements.find(e=>e.id===t);e&&(e.refinancingId=m,e.status="REFINANCIADO",e.updatedAt=f)}for(let t of h){let n={id:`mov_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,memberId:e,fecha:f.split("T")[0],concepto:`Refinanciaci\xf3n - Cuota ${t.number}/${r}`,tipo:"DEBIT",monto:t.amount,vencimiento:t.dueDate,paidAmount:0,status:"PENDIENTE",observaciones:`Refinanciaci\xf3n ${m} - Cuota ${t.number}`,...t.number&&{refinancingId:m,installmentNumber:t.number},...f&&{createdAt:f}};l.data.movements.push(n)}if(s>0){let t={id:`mov_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,memberId:e,fecha:f.split("T")[0],concepto:`Refinanciaci\xf3n - Anticipo (${i}%)`,tipo:"CREDIT",monto:s,observaciones:`Anticipo de refinanciaci\xf3n ${m}`,...m&&{refinancingId:m},...f&&{createdAt:f}};l.data.movements.push(t)}return l.data.refinancings||(l.data.refinancings=[]),l.data.refinancings.push(S),await l.write(),o.NextResponse.json({success:!0,refinancingId:m,message:"Refinanciaci\xf3n creada exitosamente",details:{principal:a,installments:r,downPaymentAmount:s,remainingAmount:p,schedule:h}})}catch(t){return console.error("Error processing refinancing:",t),o.NextResponse.json({error:"Error interno del servidor",details:t instanceof Error?t.message:"Error desconocido"},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/refinancing/process/route",pathname:"/api/refinancing/process",filename:"route",bundlePath:"app/api/refinancing/process/route"},resolvedPagePath:"C:\\Garden\\app\\api\\refinancing\\process\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:f}=d,p="/api/refinancing/process/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},9487:(t,e,n)=>{let a;n.r(e),n.d(e,{addDays:()=>$,calculateMemberDebt:()=>E,calculatePaidAmountForDebit:()=>q,computeQuote:()=>v,convertNoSocioToSocio:()=>l,endOfMonth:()=>T,formatCurrency:()=>I,getDb:()=>u,getMemberStatus:()=>P,hasReservationConflict:()=>A,nextCollectorCode:()=>m,nextCommissionId:()=>h,nextFamilyId:()=>p,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>x,nextPaymentId:()=>f,nextRefinancingId:()=>D,nextReservationId:()=>y,nextReservationPaymentId:()=>S,nextResourceId:()=>g,nextSubscriptionId:()=>b,startOfMonth:()=>M,toISODate:()=>R,yyyymm:()=>C});var r=n(26411),i=n(92048),s=n.n(i),o=n(55315),c=n.n(o);function u(){if(!a){let t=function(){let t=c().join(process.cwd(),"data");return s().existsSync(t)||s().mkdirSync(t,{recursive:!0}),c().join(t,"db.json")}();a=(0,r.cW)(t,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function d(){let t=await u();return t.data.sequences.member+=1,await t.write(),String(t.data.sequences.member)}async function l(t){let e=await u(),n=e.data.members.findIndex(e=>e.id===t);if(-1===n)throw Error("Member not found");let a=e.data.members[n];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let r=await d();return e.data.members[n]={...a,codigo:r,categoria:"Individual",subcategoria:"Socio"},await e.write(),e.data.members[n]}async function m(){let t=await u();return t.data.sequences.collector+=1,await t.write(),`COB-${String(t.data.sequences.collector).padStart(3,"0")}`}async function f(){let t=await u();return t.data.sequences.payment+=1,await t.write(),`PAY-${String(t.data.sequences.payment).padStart(6,"0")}`}async function p(){let t=await u();return t.data.sequences.family+=1,await t.write(),`FAM-${String(t.data.sequences.family).padStart(4,"0")}`}async function w(){let t=await u();return t.data.sequences.financing+=1,await t.write(),`FIN-${String(t.data.sequences.financing).padStart(4,"0")}`}async function h(){let t=await u();return t.data.sequences.commission+=1,await t.write(),`COM-${String(t.data.sequences.commission).padStart(6,"0")}`}async function g(){let t=await u();return t.data.sequences.resource+=1,await t.write(),`RESRC-${String(t.data.sequences.resource).padStart(4,"0")}`}async function y(){let t=await u();return t.data.sequences.reservation+=1,await t.write(),`RES-${String(t.data.sequences.reservation).padStart(6,"0")}`}async function S(){let t=await u();return t.data.sequences.reservationPayment+=1,await t.write(),`RESPAY-${String(t.data.sequences.reservationPayment).padStart(6,"0")}`}async function b(){let t=await u();return t.data.sequences.subscription+=1,await t.write(),`SUB-${String(t.data.sequences.subscription).padStart(6,"0")}`}async function x(){let t=await u();return t.data.sequences.movement+=1,await t.write(),`MOV-${String(t.data.sequences.movement).padStart(6,"0")}`}async function D(){let t=await u();return t.data.sequences.refinancing+=1,await t.write(),`REF-${String(t.data.sequences.refinancing).padStart(6,"0")}`}function v(t,e,n,a,r=0){let i=t.data.resources.find(t=>t.id===e),s=i?.precioBaseHora??0,o=new Date(n).getTime(),c=Math.max(1,Math.ceil((new Date(a).getTime()-o)/36e5)),u=s*c;return r>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function A(t,e,n,a,r){let i=new Date(n).getTime(),s=new Date(a).getTime();return t.data.reservations.some(t=>t.resourceId===e&&t.id!==r&&Math.max(new Date(t.start).getTime(),i)<Math.min(new Date(t.end).getTime(),s)&&"CANCELADO"!==t.status)}function I(t){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(t)}function q(t,e){if(!t||"DEBIT"!==t.tipo)return 0;let n=0;for(let a of e)if(a.allocations&&Array.isArray(a.allocations))for(let e of a.allocations)e.debitId===t.id&&(n+=Number(e.amount||0));return n}function E(t,e){let a=0;for(let n of e)if(n.memberId===t.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let t=q(n,e),r=n.monto-t;r>0&&(a+=r)}let r=n(9487),i=0;try{for(let e of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(e=>e.memberId===t.id&&("ACTIVA"===e.status||"APROBADA"===e.status)))i+=Number(e.downPaymentAmount||0)}catch(t){}return Math.max(0,a-=i)}function P(t,e){return E(t,e)>0?"ATRASADO":"AL_DIA"}function R(t){let e="string"==typeof t?new Date(t):t,n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}function $(t,e){let n=new Date("string"==typeof t?t:t.getTime());return n.setDate(n.getDate()+e),n}function M(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth(),1)}function T(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth()+1,0)}function C(t){let e="string"==typeof t?new Date(t):t;return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`}},26411:(t,e,n)=>{n.d(e,{cW:()=>m}),n(87561);var a=n(93977),r=n(49411),i=n(41041);async function s(t,e,n){for(let a=0;a<e;a++)try{return await t()}catch(t){if(a<e-1)await new Promise(t=>setTimeout(t,n));else throw t}}class o{#t;#e;#n=!1;#a=null;#r=null;#i=null;#s=null;#o(t){return this.#s=t,this.#i||=new Promise((t,e)=>{this.#r=[t,e]}),new Promise((t,e)=>{this.#i?.then(t).catch(e)})}async #c(t){this.#n=!0;try{await (0,a.writeFile)(this.#e,t,"utf-8"),await s(async()=>{await (0,a.rename)(this.#e,this.#t)},10,100),this.#a?.[0]()}catch(t){throw t instanceof Error&&this.#a?.[1](t),t}finally{if(this.#n=!1,this.#a=this.#r,this.#r=this.#i=null,null!==this.#s){let t=this.#s;this.#s=null,await this.write(t)}}}constructor(t){this.#t=t,this.#e=function(t){let e=t instanceof URL?(0,i.fileURLToPath)(t):t.toString();return(0,r.join)((0,r.dirname)(e),`.${(0,r.basename)(e)}.tmp`)}(t)}async write(t){return this.#n?this.#o(t):this.#c(t)}}class c{#t;#u;constructor(t){this.#t=t,this.#u=new o(t)}async read(){let t;try{t=await (0,a.readFile)(this.#t,"utf-8")}catch(t){if("ENOENT"===t.code)return null;throw t}return t}write(t){return this.#u.write(t)}}class u{#d;#l;#m;constructor(t,{parse:e,stringify:n}){this.#d=new c(t),this.#l=e,this.#m=n}async read(){let t=await this.#d.read();return null===t?null:this.#l(t)}write(t){return this.#d.write(this.#m(t))}}class d extends u{constructor(t){super(t,{parse:JSON.parse,stringify:t=>JSON.stringify(t,null,2)})}}class l{adapter;data;constructor(t,e){(function(t,e){if(void 0===t)throw Error("lowdb: missing adapter");if(void 0===e)throw Error("lowdb: missing default data")})(t,e),this.adapter=t,this.data=e}async read(){let t=await this.adapter.read();t&&(this.data=t)}async write(){this.data&&await this.adapter.write(this.data)}async update(t){t(this.data),await this.write()}}async function m(t,e){let n=new l(new d(t),e);return await n.read(),n}}};var e=require("../../../../webpack-runtime.js");e.C(t);var n=t=>e(e.s=t),a=e.X(0,[8948,5972],()=>n(21667));module.exports=a})();