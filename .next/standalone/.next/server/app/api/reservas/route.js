"use strict";(()=>{var e={};e.id=7783,e.ids=[7783],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},88367:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var r={};a.r(r),a.d(r,{GET:()=>d,POST:()=>l});var n=a(49303),o=a(88716),i=a(60670),s=a(87070),u=a(9487),c=a(90455);async function d(e){await (0,c.mk)(e);let{searchParams:t}=new URL(e.url),a=t.get("dateFrom"),r=t.get("dateTo"),n=t.get("status")||"",o=t.get("resourceId")||"",i=t.get("memberId")||"",d=(t.get("q")||"").toLowerCase().trim(),l=t.get("searchType")||"contacto",m="true"===t.get("includeHistory"),f=(await (0,u.getDb)()).data.reservations||[];return f=m?f.filter(e=>"CULMINADO"===e.status||"CANCELADO"===e.status):f.filter(e=>"ACTIVO"===e.status||"RESERVADO"===e.status||"CONFIRMADO"===e.status||"PENDIENTE"===e.status),a&&(f=f.filter(e=>new Date(e.start)>=new Date(a))),r&&(f=f.filter(e=>new Date(e.start)<=new Date(r))),n&&(f=f.filter(e=>e.status===n)),o&&(f=f.filter(e=>e.resourceId===o)),i&&(f=f.filter(e=>e.memberId===i)),d&&(f="evento"===l?f.filter(e=>(e.acontecimiento?.toLowerCase()||"").includes(d)||(e.quinceaneraFocusNombre?.toLowerCase()||"").includes(d)||(e.noviosNombres?.toLowerCase()||"").includes(d)||(e.cumpleaneroNombre?.toLowerCase()||"").includes(d)||(e.otrosDescripcion?.toLowerCase()||"").includes(d)||(e.otrosNombrePersona?.toLowerCase()||"").includes(d)||(e.observacionesGenerales?.toLowerCase()||"").includes(d)):f.filter(e=>(e.nombreContacto?.toLowerCase()||"").includes(d)||(e.contacto?.toLowerCase()||"").includes(d)||(e.medioContacto?.toLowerCase()||"").includes(d)||(e.notas?.toLowerCase()||"").includes(d)||(e.terceroNombre?.toLowerCase()||"").includes(d)||(e.terceroTelefono?.toLowerCase()||"").includes(d))),f=f.sort((e,t)=>new Date(e.start).getTime()-new Date(t.start).getTime()),s.NextResponse.json(f)}async function l(e){let t;let a=await (0,c.mk)(e,["admin","caja","cobranzas"]),r=await e.json().catch(()=>({})),{resourceId:n,start:o,end:i,memberId:d,nombreContacto:l,contacto:m,medioContacto:f,invitados:p=0,adelanto:g=0,notas:w="",montoTotal:b,debitMovementId:v,debitMovementIds:y,acontecimiento:D,quinceaneraFocusNombre:S,noviosNombres:N,cumpleaneroNombre:x,otrosDescripcion:I,otrosNombrePersona:h,esParaTercero:C,terceroNombre:q,terceroCedula:A,terceroTelefono:E,terceroRuc:T,cantidadPersonas:R,observacionesGenerales:M,horaExtra:P,cantidadHorasExtra:O,montoHorasExtra:$,requiereApa:F,apaComprobante:L,apaEstado:j,apaFechaEntrega:k,apaValidadoPor:B,apaObservaciones:H}=r||{};if(console.log("\uD83D\uDCCA Datos de reserva recibidos:",{resourceId:n,start:o,end:i,nombreContacto:l,contacto:m,medioContacto:f,montoTotal:b,memberId:d}),!n||!o||!i||!l)return console.error("❌ Faltan campos obligatorios:",{resourceId:n,start:o,end:i,nombreContacto:l}),s.NextResponse.json({msg:`Faltan campos obligatorios. resourceId: ${!!n}, start: ${!!o}, end: ${!!i}, nombreContacto: ${!!l}`},{status:400});let Y=await (0,u.getDb)(),V=new Date(o),G=new Date(i);if(!(V instanceof Date)||isNaN(V.getTime())||!(G instanceof Date)||isNaN(G.getTime())||G<=V)return s.NextResponse.json({msg:`Rango de fechas inv\xe1lido. Inicio: ${o}, Fin: ${i}. Verifique que las fechas sean v\xe1lidas y que la hora de fin sea posterior a la de inicio.`},{status:400});if((0,u.hasReservationConflict)(Y,n,o,i))return s.NextResponse.json({msg:`Ya existe una reserva en conflicto para el horario ${V.toLocaleString("es-ES")} - ${G.toLocaleString("es-ES")}. Verifique la disponibilidad del espacio.`},{status:409});if(Array.isArray(r.debitMovementIds)&&r.debitMovementIds.length){let e=r.debitMovementIds,a=Y.data.movements||[],s=e.map(e=>a.find(t=>t.id===e)).filter(e=>!!e).reduce((e,t)=>e+(Number(t.monto)||0),0);s>0?(void 0!==b&&Number(b)!==s&&console.warn("⚠️ Inconsistencia detectada: montoTotal enviado difiere de la suma de d\xe9bitos relacionados. Se usar\xe1 la suma de los d\xe9bitos.",{provided:b,expectedTotal:s}),t=s):t=null==b||isNaN(Number(b))?(0,u.computeQuote)(Y,n,o,i,p).monto+($?Number($):0):Number(b)}else if(null==b||isNaN(Number(b)))t=(0,u.computeQuote)(Y,n,o,i,p).monto+($?Number($):0);else if(null==$||isNaN(Number($)))t=Number(b);else{let e=Number(b),a=Number($);e<a?(console.warn("⚠️ montoTotal parece no incluir montoHorasExtra. Se ajustar\xe1 sumando montoHorasExtra.",{provided:e,montoHorasExtra:a}),t=e+a):t=e}let U=await (0,u.nextReservationId)(),_={id:U,resourceId:n,memberId:d||void 0,start:o,end:i,invitados:p,nombreContacto:l,contacto:m||"Sin especificar",medioContacto:f||"presencial",adelanto:g,montoTotal:t,status:"ACTIVO",notas:w,debitMovementIds:Array.isArray(y)&&y.length?y:void 0,debitMovementId:v||(Array.isArray(y)&&y.length?y[0]:void 0)||void 0,acontecimiento:D||void 0,quinceaneraFocusNombre:S||void 0,noviosNombres:N||void 0,cumpleaneroNombre:x||void 0,otrosDescripcion:I||void 0,otrosNombrePersona:h||void 0,esParaTercero:C||void 0,terceroNombre:q||void 0,terceroCedula:A||void 0,terceroTelefono:E||void 0,terceroRuc:T||void 0,cantidadPersonas:R?Number(R):void 0,observacionesGenerales:M||void 0,horaExtra:P||void 0,cantidadHorasExtra:O?Number(O):void 0,montoHorasExtra:$?Number($):void 0,requiereApa:F||void 0,apaComprobante:L||void 0,apaEstado:j||(F?"PENDIENTE":void 0),apaFechaEntrega:k||void 0,apaValidadoPor:B||void 0,apaObservaciones:H||void 0,createdBy:a?.email||"system",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),pagos:g>0?[{id:`RP-${Date.now()}`,reservationId:U,fecha:new Date().toISOString(),monto:Number(g)||0,metodo:"efectivo"}]:[]};return Y.data.reservations.push(_),await Y.write(),s.NextResponse.json(_,{status:201})}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/reservas/route",pathname:"/api/reservas",filename:"route",bundlePath:"app/api/reservas/route"},resolvedPagePath:"C:\\Garden\\app\\api\\reservas\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:p,serverHooks:g}=m,w="/api/reservas/route";function b(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},90455:(e,t,a)=>{a.d(t,{B$:()=>c,hm:()=>d,mk:()=>m,zB:()=>l});var r=a(41482),n=a.n(r),o=a(42023),i=a.n(o),s=a(9487);let u=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function d(){return 0===(await (0,s.getDb)()).data.users.length}async function l(e,t){let a=await (0,s.getDb)();if(0===a.data.users.length)return{token:n().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},u,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let r=a.data.users.find(t=>t.email===e);return r&&await i().compare(t,r.passwordHash)?{token:n().sign({sub:r.id,rol:r.rol,nombre:r.nombre,email:r.email},u,{expiresIn:"8h"}),user:{email:r.email,rol:r.rol,nombre:r.nombre}}:null}async function m(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let a=e.cookies.get(c)?.value;if(!a)return null;try{let e=n().verify(a,u);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,a)=>{let r;a.r(t),a.d(t,{addDays:()=>T,calculateMemberDebt:()=>q,calculatePaidAmountForDebit:()=>C,computeQuote:()=>x,convertNoSocioToSocio:()=>l,endOfMonth:()=>M,formatCurrency:()=>h,getDb:()=>c,getMemberStatus:()=>A,hasReservationConflict:()=>I,nextCollectorCode:()=>m,nextCommissionId:()=>w,nextFamilyId:()=>p,nextFinancingId:()=>g,nextMemberCode:()=>d,nextMovementId:()=>S,nextPaymentId:()=>f,nextRefinancingId:()=>N,nextReservationId:()=>v,nextReservationPaymentId:()=>y,nextResourceId:()=>b,nextSubscriptionId:()=>D,startOfMonth:()=>R,toISODate:()=>E,yyyymm:()=>P});var n=a(26411),o=a(92048),i=a.n(o),s=a(55315),u=a.n(s);function c(){if(!r){let e=function(){let e=u().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),u().join(e,"db.json")}();r=(0,n.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return r}async function d(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function l(e){let t=await c(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let r=t.data.members[a];if("NO SOCIO"!==r.subcategoria)throw Error("Member is not a no-socio");let n=await d();return t.data.members[a]={...r,codigo:n,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function m(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function b(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function v(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function D(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function N(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function x(e,t,a,r,n=0){let o=e.data.resources.find(e=>e.id===t),i=o?.precioBaseHora??0,s=new Date(a).getTime(),u=Math.max(1,Math.ceil((new Date(r).getTime()-s)/36e5)),c=i*u;return n>100&&(c=Math.round(1.05*c)),{horas:u,monto:c}}function I(e,t,a,r,n){let o=new Date(a).getTime(),i=new Date(r).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==n&&Math.max(new Date(e.start).getTime(),o)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function h(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function C(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let r of t)if(r.allocations&&Array.isArray(r.allocations))for(let t of r.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function q(e,t){let r=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=C(a,t),n=a.monto-e;n>0&&(r+=n)}let n=a(9487),o=0;try{for(let t of(n.getDb&&"function"==typeof n.getDb&&n.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))o+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,r-=o)}function A(e,t){return q(e,t)>0?"ATRASADO":"AL_DIA"}function E(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${a}-${r}-${n}`}function T(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function R(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function P(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,1482,4565],()=>a(88367));module.exports=r})();