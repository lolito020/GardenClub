"use strict";(()=>{var t={};t.id=3272,t.ids=[3272],t.modules={20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:t=>{t.exports=require("fs")},55315:t=>{t.exports=require("path")},87561:t=>{t.exports=require("node:fs")},93977:t=>{t.exports=require("node:fs/promises")},49411:t=>{t.exports=require("node:path")},41041:t=>{t.exports=require("node:url")},16653:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{PATCH:()=>u});var r=a(49303),i=a(88716),s=a(60670),o=a(87070),c=a(9487);async function u(t,{params:e}){try{let{id:a}=e,n=await t.json(),r=await (0,c.getDb)(),i=r.data.reservations,s=i.findIndex(t=>t.id===a);if(-1===s)return o.NextResponse.json({error:"Reservaci\xf3n no encontrada"},{status:404});let u=["apaEstado","apaComprobante","apaObservaciones","apaFechaEntrega","apaFechaRevision"],d={};for(let[t,e]of Object.entries(n))u.includes(t)&&(d[t]=e);("APROBADO"===d.apaEstado||"RECHAZADO"===d.apaEstado)&&(d.apaFechaRevision=new Date().toISOString());let l={...i[s],...d,updatedAt:new Date().toISOString()};return i[s]=l,await r.write(),console.log(`APA Status Update - Reservation: ${a}, New Status: ${d.apaEstado}, Timestamp: ${new Date().toISOString()}`),o.NextResponse.json({success:!0,reservation:l,message:`Estado APA actualizado a: ${d.apaEstado}`})}catch(t){return console.error("Error updating APA status:",t),o.NextResponse.json({error:"Error interno del servidor al actualizar estado APA"},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reservas/[id]/apa-status/route",pathname:"/api/reservas/[id]/apa-status",filename:"route",bundlePath:"app/api/reservas/[id]/apa-status/route"},resolvedPagePath:"C:\\Garden\\app\\api\\reservas\\[id]\\apa-status\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:p}=d,f="/api/reservas/[id]/apa-status/route";function w(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},9487:(t,e,a)=>{let n;a.r(e),a.d(e,{addDays:()=>R,calculateMemberDebt:()=>I,calculatePaidAmountForDebit:()=>P,computeQuote:()=>D,convertNoSocioToSocio:()=>l,endOfMonth:()=>M,formatCurrency:()=>q,getDb:()=>u,getMemberStatus:()=>E,hasReservationConflict:()=>A,nextCollectorCode:()=>m,nextCommissionId:()=>h,nextFamilyId:()=>f,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>x,nextPaymentId:()=>p,nextRefinancingId:()=>b,nextReservationId:()=>y,nextReservationPaymentId:()=>S,nextResourceId:()=>g,nextSubscriptionId:()=>v,startOfMonth:()=>F,toISODate:()=>O,yyyymm:()=>C});var r=a(26411),i=a(92048),s=a.n(i),o=a(55315),c=a.n(o);function u(){if(!n){let t=function(){let t=c().join(process.cwd(),"data");return s().existsSync(t)||s().mkdirSync(t,{recursive:!0}),c().join(t,"db.json")}();n=(0,r.cW)(t,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function d(){let t=await u();return t.data.sequences.member+=1,await t.write(),String(t.data.sequences.member)}async function l(t){let e=await u(),a=e.data.members.findIndex(e=>e.id===t);if(-1===a)throw Error("Member not found");let n=e.data.members[a];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let r=await d();return e.data.members[a]={...n,codigo:r,categoria:"Individual",subcategoria:"Socio"},await e.write(),e.data.members[a]}async function m(){let t=await u();return t.data.sequences.collector+=1,await t.write(),`COB-${String(t.data.sequences.collector).padStart(3,"0")}`}async function p(){let t=await u();return t.data.sequences.payment+=1,await t.write(),`PAY-${String(t.data.sequences.payment).padStart(6,"0")}`}async function f(){let t=await u();return t.data.sequences.family+=1,await t.write(),`FAM-${String(t.data.sequences.family).padStart(4,"0")}`}async function w(){let t=await u();return t.data.sequences.financing+=1,await t.write(),`FIN-${String(t.data.sequences.financing).padStart(4,"0")}`}async function h(){let t=await u();return t.data.sequences.commission+=1,await t.write(),`COM-${String(t.data.sequences.commission).padStart(6,"0")}`}async function g(){let t=await u();return t.data.sequences.resource+=1,await t.write(),`RESRC-${String(t.data.sequences.resource).padStart(4,"0")}`}async function y(){let t=await u();return t.data.sequences.reservation+=1,await t.write(),`RES-${String(t.data.sequences.reservation).padStart(6,"0")}`}async function S(){let t=await u();return t.data.sequences.reservationPayment+=1,await t.write(),`RESPAY-${String(t.data.sequences.reservationPayment).padStart(6,"0")}`}async function v(){let t=await u();return t.data.sequences.subscription+=1,await t.write(),`SUB-${String(t.data.sequences.subscription).padStart(6,"0")}`}async function x(){let t=await u();return t.data.sequences.movement+=1,await t.write(),`MOV-${String(t.data.sequences.movement).padStart(6,"0")}`}async function b(){let t=await u();return t.data.sequences.refinancing+=1,await t.write(),`REF-${String(t.data.sequences.refinancing).padStart(6,"0")}`}function D(t,e,a,n,r=0){let i=t.data.resources.find(t=>t.id===e),s=i?.precioBaseHora??0,o=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(n).getTime()-o)/36e5)),u=s*c;return r>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function A(t,e,a,n,r){let i=new Date(a).getTime(),s=new Date(n).getTime();return t.data.reservations.some(t=>t.resourceId===e&&t.id!==r&&Math.max(new Date(t.start).getTime(),i)<Math.min(new Date(t.end).getTime(),s)&&"CANCELADO"!==t.status)}function q(t){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(t)}function P(t,e){if(!t||"DEBIT"!==t.tipo)return 0;let a=0;for(let n of e)if(n.allocations&&Array.isArray(n.allocations))for(let e of n.allocations)e.debitId===t.id&&(a+=Number(e.amount||0));return a}function I(t,e){let n=0;for(let a of e)if(a.memberId===t.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let t=P(a,e),r=a.monto-t;r>0&&(n+=r)}let r=a(9487),i=0;try{for(let e of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(e=>e.memberId===t.id&&("ACTIVA"===e.status||"APROBADA"===e.status)))i+=Number(e.downPaymentAmount||0)}catch(t){}return Math.max(0,n-=i)}function E(t,e){return I(t,e)>0?"ATRASADO":"AL_DIA"}function O(t){let e="string"==typeof t?new Date(t):t,a=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${n}-${r}`}function R(t,e){let a=new Date("string"==typeof t?t:t.getTime());return a.setDate(a.getDate()+e),a}function F(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth(),1)}function M(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth()+1,0)}function C(t){let e="string"==typeof t?new Date(t):t;return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`}},26411:(t,e,a)=>{a.d(e,{cW:()=>m}),a(87561);var n=a(93977),r=a(49411),i=a(41041);async function s(t,e,a){for(let n=0;n<e;n++)try{return await t()}catch(t){if(n<e-1)await new Promise(t=>setTimeout(t,a));else throw t}}class o{#t;#e;#a=!1;#n=null;#r=null;#i=null;#s=null;#o(t){return this.#s=t,this.#i||=new Promise((t,e)=>{this.#r=[t,e]}),new Promise((t,e)=>{this.#i?.then(t).catch(e)})}async #c(t){this.#a=!0;try{await (0,n.writeFile)(this.#e,t,"utf-8"),await s(async()=>{await (0,n.rename)(this.#e,this.#t)},10,100),this.#n?.[0]()}catch(t){throw t instanceof Error&&this.#n?.[1](t),t}finally{if(this.#a=!1,this.#n=this.#r,this.#r=this.#i=null,null!==this.#s){let t=this.#s;this.#s=null,await this.write(t)}}}constructor(t){this.#t=t,this.#e=function(t){let e=t instanceof URL?(0,i.fileURLToPath)(t):t.toString();return(0,r.join)((0,r.dirname)(e),`.${(0,r.basename)(e)}.tmp`)}(t)}async write(t){return this.#a?this.#o(t):this.#c(t)}}class c{#t;#u;constructor(t){this.#t=t,this.#u=new o(t)}async read(){let t;try{t=await (0,n.readFile)(this.#t,"utf-8")}catch(t){if("ENOENT"===t.code)return null;throw t}return t}write(t){return this.#u.write(t)}}class u{#d;#l;#m;constructor(t,{parse:e,stringify:a}){this.#d=new c(t),this.#l=e,this.#m=a}async read(){let t=await this.#d.read();return null===t?null:this.#l(t)}write(t){return this.#d.write(this.#m(t))}}class d extends u{constructor(t){super(t,{parse:JSON.parse,stringify:t=>JSON.stringify(t,null,2)})}}class l{adapter;data;constructor(t,e){(function(t,e){if(void 0===t)throw Error("lowdb: missing adapter");if(void 0===e)throw Error("lowdb: missing default data")})(t,e),this.adapter=t,this.data=e}async read(){let t=await this.adapter.read();t&&(this.data=t)}async write(){this.data&&await this.adapter.write(this.data)}async update(t){t(this.data),await this.write()}}async function m(t,e){let a=new l(new d(t),e);return await a.read(),a}}};var e=require("../../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),n=e.X(0,[8948,5972],()=>a(16653));module.exports=n})();