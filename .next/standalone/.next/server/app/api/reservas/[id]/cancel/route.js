"use strict";(()=>{var e={};e.id=3954,e.ids=[3954],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},50673:(e,o,t)=>{t.r(o),t.d(o,{originalPathname:()=>x,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{PATCH:()=>u});var s=t(49303),n=t(88716),r=t(60670),i=t(87070),l=t(9487),d=t(90455),c=t(75747);async function u(e,{params:o}){let t=await (0,d.mk)(e,["admin","caja","cobranzas"]),a=o.id,{refundType:s,refundAmount:n,penaltyAmount:r,cancelReason:u}=await e.json().catch(()=>({}));if(!s||!["NINGUNO","TOTAL","PARCIAL"].includes(s))return i.NextResponse.json({msg:"Debe especificar tipo de reembolso: NINGUNO, TOTAL o PARCIAL"},{status:400});if("PARCIAL"===s){if(void 0===n||void 0===r)return i.NextResponse.json({msg:"Para reembolso PARCIAL debe especificar refundAmount y penaltyAmount"},{status:400});if(n<0||r<0)return i.NextResponse.json({msg:"Los montos deben ser mayores o iguales a cero"},{status:400})}let p=await (0,l.getDb)(),m=p.data.reservations.find(e=>e.id===a);if(!m)return i.NextResponse.json({msg:"Reserva no encontrada"},{status:404});if("CANCELADO"===m.status)return i.NextResponse.json({msg:"La reserva ya est\xe1 cancelada"},{status:400});if(!m.memberId)return i.NextResponse.json({msg:"La reserva no tiene un socio asociado"},{status:400});try{let e=m.montoTotal,o=m.memberId,l=[],d=[];m.debitMovementIds&&m.debitMovementIds.length>0?d.push(...m.debitMovementIds):m.debitMovementId&&d.push(m.debitMovementId);let f=0;for(let e of p.data.movements.filter(e=>"CREDIT"===e.tipo&&e.allocations&&e.allocations.some(e=>d.includes(e.debitId||""))))if(e.allocations){let o=e.allocations.filter(e=>d.includes(e.debitId||"")).reduce((e,o)=>e+Math.abs(o.amount||0),0);f+=o}console.log(`ðŸ’° Cancelaci\xf3n Reserva ${a}: Total reserva=${e}, Total pagado=${f}`),console.log(`ðŸ” DEBUG: refundType=${s}, penaltyAmount=${r}, refundAmount=${n}`);let g=await (0,c.oM)(a,d),x=await (0,c.Fd)(o,a,e,d);l.push(x);let A=0,v=0;if("NINGUNO"===s){if(console.log(`ðŸ” DEBUG: Entrando en caso NINGUNO`),f>0){console.log(`âœ… NINGUNO: creando penalizaci\xf3n por ${f} sin compensaci\xf3n`);let e=await (0,c.Tx)(o,a,f,!1);l.push(e.debitId),v=f}else console.log(`â„¹ï¸ Sin reembolso pero sin pagos previos. Solo se emite nota de cr\xe9dito de cancelaci\xf3n.`);A=0}else if("TOTAL"===s){if(f>0){console.log(`âœ… TOTAL: creando d\xe9bito de reembolso por ${f}`);let e=await (0,c.Nc)(o,a,f);l.push(e),A=f}else console.log(`â„¹ï¸ Reembolso total pero sin pagos previos. Solo se emite nota de cr\xe9dito de cancelaci\xf3n.`),A=0;v=0}else if("PARCIAL"===s){let t=(n||0)+(r||0);if(0===f)return i.NextResponse.json({msg:"No se puede hacer reembolso parcial porque no hay pagos registrados"},{status:400});if(Math.abs(t-f)>1)return i.NextResponse.json({msg:`La suma de refundAmount (${n}) + penaltyAmount (${r}) debe ser igual al total pagado (${f})`},{status:400});if(r>0){let t=1>Math.abs(f-e);if(console.log(`ðŸ” DEBUG PARCIAL: totalPagado=${f}, totalAmount=${e}, isPagoContado=${t}`),t){console.log(`âœ… Pago contado: creando penalizaci\xf3n con createPenaltyDebitContado`);let e=await (0,c.h2)(o,a,r);l.push(e)}else{console.log(`âœ… Pago a cr\xe9dito: creando penalizaci\xf3n SIN compensaci\xf3n`);let{debitId:e}=await (0,c.Tx)(o,a,r,!1);l.push(e)}}if(n>0){console.log(`âœ… PARCIAL: creando d\xe9bito de reembolso por ${n}`);let e=await (0,c.Nc)(o,a,n);l.push(e)}A=n,v=r}d.length>0&&await (0,c.i7)(a,d);let b=new Date().toISOString();return m.status="CANCELADO",m.cancelledAt=b,m.cancelledBy=t?.email||"system",m.cancelReason=u||"Cancelaci\xf3n solicitada",m.refundType=s,m.refundAmount=A,m.penaltyAmount=v,m.updatedAt=b,m.refundMovementIds||(m.refundMovementIds=[]),m.refundMovementIds.push(...l),await p.write(),i.NextResponse.json({msg:"Reserva cancelada exitosamente",reservation:m,cancellationDetails:{refundType:s,totalAmount:e,totalPagado:f,refundAmount:A,penaltyAmount:v,deletedPayments:g,movementsCreated:l.length,movementIds:l}})}catch(e){return console.error("Error cancelando reserva:",e),i.NextResponse.json({msg:`Error al cancelar reserva: ${e instanceof Error?e.message:"Error desconocido"}`},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/reservas/[id]/cancel/route",pathname:"/api/reservas/[id]/cancel",filename:"route",bundlePath:"app/api/reservas/[id]/cancel/route"},resolvedPagePath:"C:\\Garden\\app\\api\\reservas\\[id]\\cancel\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=p,x="/api/reservas/[id]/cancel/route";function A(){return(0,r.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}}};var o=require("../../../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),a=o.X(0,[8948,5972,1482,4565,14],()=>t(50673));module.exports=a})();