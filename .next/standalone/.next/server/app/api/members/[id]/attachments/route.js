"use strict";(()=>{var e={};e.id=1127,e.ids=[1127],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},98653:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>q,patchFetch:()=>v,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>D,staticGenerationAsyncStorage:()=>S});var n={};a.r(n),a.d(n,{DELETE:()=>b,GET:()=>w,POST:()=>y,dynamic:()=>g,runtime:()=>f});var r=a(49303),i=a(88716),s=a(60670),o=a(87070),u=a(9487),c=a(40259),m=a(55315),l=a.n(m),d=a(20629),p=a(90455);let f="nodejs",g="force-dynamic";async function w(e,{params:t}){if(!await (0,p.mk)(e,["admin","caja","consulta"]))return o.NextResponse.json({ok:!1,msg:"Unauthorized"},{status:401});try{let e=await (0,u.getDb)();e.data.attachments||=[];let a=t.id,n=e.data.attachments.filter(e=>e.memberId===a);return o.NextResponse.json(n)}catch(e){return console.error("Error getting member attachments:",e),o.NextResponse.json({ok:!1,msg:"Error al obtener adjuntos"},{status:500})}}async function y(e,{params:t}){if(!await (0,p.mk)(e,["admin","caja"]))return o.NextResponse.json({ok:!1,msg:"Unauthorized"},{status:401});let a=e.headers.get("content-type")||"",n=/multipart\/form-data/i.test(a),r=/application\/x-www-form-urlencoded/i.test(a);if(!n&&!r)return o.NextResponse.json({ok:!1,msg:`Content-Type inv\xe1lido. Se esperaba "multipart/form-data" (o "application/x-www-form-urlencoded"), se recibi\xf3: "${a||"N/A"}".`},{status:415});try{let a=t.id,n=await e.formData(),r=n.getAll("files"),i=n.getAll("file"),s=[...r,...i].filter(e=>e&&"object"==typeof e&&"function"==typeof e.arrayBuffer),m=(n.get("descripcion")?.toString()||"").trim();if(!s||0===s.length)return o.NextResponse.json({ok:!1,msg:'No se recibieron archivos en los campos "files" o "file".'},{status:400});let p=l().join(process.cwd(),"public","uploads",a);await (0,d.mkdir)(p,{recursive:!0});let f=await (0,u.getDb)();f.data.attachments||=[];let g=[];for(let e of s){let t=await e.arrayBuffer(),n=Buffer.from(t),r=(e.name||"archivo").replace(/[^a-z0-9.\-_\s]/gi,"_"),i=l().extname(r),s=(0,c.x0)(),o=`${Date.now()}_${s}${i||""}`,u=l().join(p,o);await (0,d.writeFile)(u,n);let w=`/uploads/${a}/${o}`,y={id:s,memberId:a,nombre:r,url:w,mime:e.type||"application/octet-stream",size:e.size||n.byteLength,...m?{descripcion:m}:{},fecha:new Date().toISOString()};f.data.attachments.push(y),g.push(y)}return await f.write(),o.NextResponse.json(g,{status:201})}catch(e){return console.error("POST /attachments error",e),o.NextResponse.json({ok:!1,msg:e?.message||"Error al subir adjuntos"},{status:500})}}async function b(e,{params:t}){if(!await (0,p.mk)(e,["admin","caja"]))return o.NextResponse.json({ok:!1,msg:"Unauthorized"},{status:401});try{let a=new URL(e.url).searchParams.get("attachmentId");if(!a)return o.NextResponse.json({ok:!1,msg:"attachmentId requerido"},{status:400});let n=await (0,u.getDb)();n.data.attachments||=[];let r=n.data.attachments,i=r.findIndex(e=>e.id===a&&e.memberId===t.id);if(-1===i)return o.NextResponse.json({ok:!1,msg:"Adjunto no encontrado"},{status:404});let[s]=r.splice(i,1);await n.write();let c=l().join(process.cwd(),"public",s.url.replace(/^\/+/,""));try{await (0,d.unlink)(c)}catch{}return o.NextResponse.json({ok:!0})}catch(e){return console.error("DELETE /attachments error",e),o.NextResponse.json({ok:!1,msg:e?.message||"Error al eliminar adjunto"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/members/[id]/attachments/route",pathname:"/api/members/[id]/attachments",filename:"route",bundlePath:"app/api/members/[id]/attachments/route"},resolvedPagePath:"C:\\Garden\\app\\api\\members\\[id]\\attachments\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:S,serverHooks:D}=h,q="/api/members/[id]/attachments/route";function v(){return(0,s.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:S})}},90455:(e,t,a)=>{a.d(t,{B$:()=>c,hm:()=>m,mk:()=>d,zB:()=>l});var n=a(41482),r=a.n(n),i=a(42023),s=a.n(i),o=a(9487);let u=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function m(){return 0===(await (0,o.getDb)()).data.users.length}async function l(e,t){let a=await (0,o.getDb)();if(0===a.data.users.length)return{token:r().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},u,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let n=a.data.users.find(t=>t.email===e);return n&&await s().compare(t,n.passwordHash)?{token:r().sign({sub:n.id,rol:n.rol,nombre:n.nombre,email:n.email},u,{expiresIn:"8h"}),user:{email:n.email,rol:n.rol,nombre:n.nombre}}:null}async function d(e,t){if(0===(await (0,o.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let a=e.cookies.get(c)?.value;if(!a)return null;try{let e=r().verify(a,u);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,a)=>{let n;a.r(t),a.d(t,{addDays:()=>E,calculateMemberDebt:()=>R,calculatePaidAmountForDebit:()=>I,computeQuote:()=>q,convertNoSocioToSocio:()=>l,endOfMonth:()=>M,formatCurrency:()=>A,getDb:()=>c,getMemberStatus:()=>j,hasReservationConflict:()=>v,nextCollectorCode:()=>d,nextCommissionId:()=>w,nextFamilyId:()=>f,nextFinancingId:()=>g,nextMemberCode:()=>m,nextMovementId:()=>S,nextPaymentId:()=>p,nextRefinancingId:()=>D,nextReservationId:()=>b,nextReservationPaymentId:()=>h,nextResourceId:()=>y,nextSubscriptionId:()=>x,startOfMonth:()=>N,toISODate:()=>k,yyyymm:()=>P});var r=a(26411),i=a(92048),s=a.n(i),o=a(55315),u=a.n(o);function c(){if(!n){let e=function(){let e=u().join(process.cwd(),"data");return s().existsSync(e)||s().mkdirSync(e,{recursive:!0}),u().join(e,"db.json")}();n=(0,r.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function m(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function l(e){let t=await c(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let n=t.data.members[a];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let r=await m();return t.data.members[a]={...n,codigo:r,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function d(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function p(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function f(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function b(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function h(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function x(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function D(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function q(e,t,a,n,r=0){let i=e.data.resources.find(e=>e.id===t),s=i?.precioBaseHora??0,o=new Date(a).getTime(),u=Math.max(1,Math.ceil((new Date(n).getTime()-o)/36e5)),c=s*u;return r>100&&(c=Math.round(1.05*c)),{horas:u,monto:c}}function v(e,t,a,n,r){let i=new Date(a).getTime(),s=new Date(n).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==r&&Math.max(new Date(e.start).getTime(),i)<Math.min(new Date(e.end).getTime(),s)&&"CANCELADO"!==e.status)}function A(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function I(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let n of t)if(n.allocations&&Array.isArray(n.allocations))for(let t of n.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function R(e,t){let n=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=I(a,t),r=a.monto-e;r>0&&(n+=r)}let r=a(9487),i=0;try{for(let t of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))i+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,n-=i)}function j(e,t){return R(e,t)>0?"ATRASADO":"AL_DIA"}function k(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${a}-${n}-${r}`}function E(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function N(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function P(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},40259:(e,t,a)=>{let n,r;a.d(t,{x0:()=>s});let i=require("node:crypto");function s(e=21){var t;t=e-=0,!n||n.length<t?(n=Buffer.allocUnsafe(128*t),i.webcrypto.getRandomValues(n),r=0):r+t>n.length&&(i.webcrypto.getRandomValues(n),r=0),r+=t;let a="";for(let t=r-e;t<r;t++)a+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[t]];return a}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,4565],()=>a(98653));module.exports=n})();