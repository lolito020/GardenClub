"use strict";(()=>{var e={};e.id=5091,e.ids=[5091],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},11109:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>N,patchFetch:()=>I,requestAsyncStorage:()=>y,routeModule:()=>S,serverHooks:()=>D,staticGenerationAsyncStorage:()=>$});var a={};n.r(a),n.d(a,{DELETE:()=>x,GET:()=>w,POST:()=>v,dynamic:()=>h});var r=n(49303),o=n(88716),s=n(60670),i=n(87070),u=n(9487),c=n(90455),l=n(92906);let d=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];function m(e){if(e<1||e>12)throw Error(`Mes inv\xe1lido: ${e}`);return d[e-1]}function g(e,t){return`${e}-${t.toString().padStart(2,"0")}`}function p(e){if(e.metadata?.monthCode)return e.metadata.monthCode;if(e.observaciones){let t=e.observaciones.match(/mes de (\w+)\s+(\d{4})|(\w+)\s+(\d{4})/i);if(t){let e=(t[1]||t[3]).toLowerCase(),n=t[2]||t[4],a=d.indexOf(e);if(-1!==a)return`${n}-${(a+1).toString().padStart(2,"0")}`}}if(e.concepto){let t=e.concepto.match(/(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)\s+(\d{4})/i);if(t){let e=t[1].toLowerCase(),n=t[2],a=d.indexOf(e);if(-1!==a)return`${n}-${(a+1).toString().padStart(2,"0")}`}}if(e.vencimiento){let t=new Date(e.vencimiento),n=t.getUTCMonth()+1,a=t.getUTCFullYear();return`${a}-${n.toString().padStart(2,"0")}`}return null}function f(e,t,n,a){let r={year:n,memberId:e.id,memberCode:e.codigo,memberName:`${e.nombres} ${e.apellidos}`,subcategoria:e.subcategoria,fechaAlta:e.alta,existingDebits:[],missingMonths:[],canGenerate:!1,canRevert:!1,monthsToGenerate:0,totalAmountToGenerate:0,revertableDebits:[],warnings:[],errors:[]};if("Socio Vitalicio"===e.subcategoria)return r.errors.push("Los socios vitalicios no pagan cuota social mensual"),r;if(!["Socio","Socio Patrimonial"].includes(e.subcategoria))return r.errors.push(`La subcategor\xeda "${e.subcategoria}" no aplica cuota social mensual`),r;let o=new Date(e.alta),s=o.getFullYear(),i=o.getMonth()+1;if(s>n)return r.errors.push(`El socio ingres\xf3 en ${s}, no puede generar cuotas para ${n}`),r;let u=s===n?i:1,c=t.filter(e=>{if("DEBIT"!==e.tipo||!function(e){if("s1"===e.refId||"s1"===e.serviceId)return!0;let t=`${e.concepto||""} ${e.observaciones||""}`.toLowerCase(),n=t.includes("cuota social")||t.includes("cuota mensual"),a="MENSUAL"===e.tipoServicio;return n&&a}(e))return!1;let t=p(e);if(!t)return!1;let[a]=t.split("-").map(Number);return a===n}),l=new Map;for(let e of c){let t=p(e);if(!t)continue;let[,n]=t.split("-"),a=parseInt(n,10);(!l.has(a)||new Date(e.createdAt||e.fecha)>new Date(l.get(a).createdAt||l.get(a).fecha))&&l.set(a,e)}for(let[e,t]of l.entries())r.existingDebits.push({month:e,monthCode:g(n,e),monthText:`${m(e)} ${n}`,debitId:t.id,status:t.status||"PENDIENTE",monto:t.monto,paidAmount:t.paidAmount||0,vencimiento:t.vencimiento,createdAt:t.createdAt||t.fecha}),"PENDIENTE"===t.status&&0===(t.paidAmount||0)&&r.revertableDebits.push(t.id);for(let e=u;e<=12;e++)l.has(e)||r.missingMonths.push(e);return r.monthsToGenerate=r.missingMonths.length,r.totalAmountToGenerate=r.monthsToGenerate*a,r.canGenerate=r.monthsToGenerate>0,r.canRevert=r.revertableDebits.length>0,s===n&&i>1&&r.warnings.push(`El socio ingres\xf3 en ${m(i)} ${n}, se generar\xe1n cuotas desde ${m(i)} hasta diciembre`),0===r.monthsToGenerate&&12===r.existingDebits.length&&r.warnings.push(`Ya existen d\xe9bitos para todos los meses de ${n}`),l.size>12&&r.warnings.push("Se detectaron d\xe9bitos duplicados para algunos meses"),r}function b(e){return e?"Socio Vitalicio"===e.subcategoria?{valid:!1,error:"Los socios vitalicios est\xe1n exentos de cuota social"}:["Socio","Socio Patrimonial"].includes(e.subcategoria)?{valid:!0}:{valid:!1,error:"Solo aplica para socios y socios patrimoniales"}:{valid:!1,error:"Socio no encontrado"}}let h="force-dynamic";async function w(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja"]))return i.NextResponse.json({ok:!1,msg:"No autorizado"},{status:401});try{let{searchParams:n}=new URL(e.url),a=n.get("year"),r=a?parseInt(a,10):(0,l.tF)().getUTCFullYear();if(isNaN(r)||r<2e3||r>2100)return i.NextResponse.json({ok:!1,msg:"A\xf1o inv\xe1lido"},{status:400});let o=await (0,u.getDb)(),s=o.data.members?.find(e=>e.id===t.id);if(!s)return i.NextResponse.json({ok:!1,msg:"Socio no encontrado"},{status:404});let c=b(s);if(!c.valid)return i.NextResponse.json({ok:!1,msg:c.error},{status:400});let d=o.data.services?.find(e=>"s1"===e.id);if(!d)return i.NextResponse.json({ok:!1,msg:"Servicio de cuota social no encontrado"},{status:500});let m=o.data.movements?.filter(e=>e.memberId===t.id)||[],g=f(s,m,r,d.precio);return i.NextResponse.json({ok:!0,analysis:g})}catch(e){return console.error("Error al analizar cuotas anuales:",e),i.NextResponse.json({ok:!1,msg:"Error al analizar cuotas anuales",error:e.message},{status:500})}}async function v(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja"]))return i.NextResponse.json({ok:!1,msg:"No autorizado"},{status:401});try{let{year:n,force:a=!1}=await e.json(),r=n||(0,l.tF)().getUTCFullYear();if(isNaN(r)||r<2e3||r>2100)return i.NextResponse.json({ok:!1,msg:"A\xf1o inv\xe1lido"},{status:400});let o=await (0,u.getDb)(),s=o.data.members?.find(e=>e.id===t.id);if(!s)return i.NextResponse.json({ok:!1,msg:"Socio no encontrado"},{status:404});let c=b(s);if(!c.valid)return i.NextResponse.json({ok:!1,msg:c.error},{status:400});let d=o.data.services?.find(e=>"s1"===e.id);if(!d)return i.NextResponse.json({ok:!1,msg:"Servicio de cuota social no encontrado"},{status:500});if(!d.activo)return i.NextResponse.json({ok:!1,msg:"El servicio de cuota social est\xe1 inactivo"},{status:400});let p=o.data.movements?.filter(e=>e.memberId===t.id)||[],h=f(s,p,r,d.precio);if(h.errors.length>0)return i.NextResponse.json({ok:!1,msg:h.errors.join("; "),errors:h.errors},{status:400});if(!h.canGenerate&&!a)return i.NextResponse.json({ok:!1,msg:`No hay meses pendientes para generar en ${r}`,analysis:h},{status:400});let w=function(e,t){if(!e.canGenerate)return[];let n=`BATCH-${e.year}-${Date.now()}`;(0,l.LJ)();let a=[];for(let r of e.missingMonths){let o=m(r),s=g(e.year,r),i=function(e,t){let n=new Date(e,t,0);return`${e}-${t.toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")}`}(e.year,r),u=`${e.year}-${r.toString().padStart(2,"0")}-01`;a.push({memberId:e.memberId,fecha:`${u}T12:00:00.000Z`,concepto:`Cuota Social Mensual - ${o.charAt(0).toUpperCase()+o.slice(1)} ${e.year}`,tipo:"DEBIT",monto:t,origen:"SERVICIO",refId:"s1",serviceId:"s1",tipoServicio:"MENSUAL",observaciones:`Mes de ${o} ${e.year}`,vencimiento:`${i}T12:00:00.000Z`,metadata:{generationType:"ANNUAL_BATCH",batchYear:e.year,batchId:n,monthNumber:r,monthCode:s}})}return a}(h,d.precio);if(0===w.length)return i.NextResponse.json({ok:!1,msg:"No se generaron d\xe9bitos",analysis:h},{status:400});o.data.movements=o.data.movements||[];let v=[],x=(0,l.tF)().toISOString();for(let e of w){let t={id:await (0,u.nextMovementId)(),...e,createdAt:x,paidAmount:0,status:"PENDIENTE"};o.data.movements.push(t),v.push({id:t.id,month:e.metadata.monthNumber,monthText:e.metadata.monthCode,monthName:e.concepto.split(" - ")[1],amount:e.monto,dueDate:e.vencimiento})}return await o.write(),console.log(`✅ Cuotas anuales generadas para ${s.codigo} - ${s.nombres} ${s.apellidos}`),console.log(`   A\xf1o: ${r}`),console.log(`   Meses generados: ${v.length}`),console.log(`   Monto total: Gs. ${h.totalAmountToGenerate.toLocaleString("es-PY")}`),i.NextResponse.json({ok:!0,msg:`Se generaron ${v.length} d\xe9bitos de cuota social para ${r}`,generated:v,totalGenerated:v.length,totalAmount:h.totalAmountToGenerate,skipped:h.existingDebits.map(e=>e.monthText),analysis:h},{status:201})}catch(e){return console.error("Error al generar cuotas anuales:",e),i.NextResponse.json({ok:!1,msg:"Error al generar cuotas anuales",error:e.message},{status:500})}}async function x(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja"]))return i.NextResponse.json({ok:!1,msg:"No autorizado"},{status:401});try{let{searchParams:n}=new URL(e.url),a=n.get("year"),r=a?parseInt(a,10):(0,l.tF)().getUTCFullYear();if(isNaN(r)||r<2e3||r>2100)return i.NextResponse.json({ok:!1,msg:"A\xf1o inv\xe1lido"},{status:400});let o=await (0,u.getDb)(),s=o.data.members?.find(e=>e.id===t.id);if(!s)return i.NextResponse.json({ok:!1,msg:"Socio no encontrado"},{status:404});let c=o.data.services?.find(e=>"s1"===e.id);if(!c)return i.NextResponse.json({ok:!1,msg:"Servicio de cuota social no encontrado"},{status:500});let d=o.data.movements?.filter(e=>e.memberId===t.id)||[],m=f(s,d,r,c.precio);if(!m.canRevert||0===m.revertableDebits.length)return i.NextResponse.json({ok:!1,msg:`No hay d\xe9bitos pendientes para revertir en ${r}`,analysis:m},{status:400});let g=[],p=[],b=o.data.movements.length;o.data.movements=o.data.movements.filter(e=>{if(m.revertableDebits.includes(e.id)){let t=m.existingDebits.find(t=>t.debitId===e.id);return g.push({id:e.id,month:t?.month,monthText:t?.monthText,amount:e.monto}),!1}let t=m.existingDebits.find(t=>t.debitId===e.id);return t&&"PENDIENTE"!==t.status&&p.push({id:e.id,month:t.month,monthText:t.monthText,reason:`Tiene pagos aplicados (status: ${t.status})`}),!0});let h=o.data.movements.length;if(0==b-h)return i.NextResponse.json({ok:!1,msg:"No se pudo eliminar ning\xfan d\xe9bito",skipped:p},{status:400});await o.write();let w=g.reduce((e,t)=>e+t.amount,0);return console.log(`⚠️  Cuotas anuales revertidas para ${s.codigo} - ${s.nombres} ${s.apellidos}`),console.log(`   A\xf1o: ${r}`),console.log(`   D\xe9bitos eliminados: ${g.length}`),console.log(`   Monto total: Gs. ${w.toLocaleString("es-PY")}`),i.NextResponse.json({ok:!0,msg:`Se revirtieron ${g.length} d\xe9bitos de cuota social de ${r}`,deleted:g,totalDeleted:g.length,totalAmount:w,skipped:p})}catch(e){return console.error("Error al revertir cuotas anuales:",e),i.NextResponse.json({ok:!1,msg:"Error al revertir cuotas anuales",error:e.message},{status:500})}}let S=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/members/[id]/generate-annual-quotas/route",pathname:"/api/members/[id]/generate-annual-quotas",filename:"route",bundlePath:"app/api/members/[id]/generate-annual-quotas/route"},resolvedPagePath:"C:\\Garden\\app\\api\\members\\[id]\\generate-annual-quotas\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:$,serverHooks:D}=S,N="/api/members/[id]/generate-annual-quotas/route";function I(){return(0,s.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:$})}},90455:(e,t,n)=>{n.d(t,{B$:()=>c,hm:()=>l,mk:()=>m,zB:()=>d});var a=n(41482),r=n.n(a),o=n(42023),s=n.n(o),i=n(9487);let u=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function l(){return 0===(await (0,i.getDb)()).data.users.length}async function d(e,t){let n=await (0,i.getDb)();if(0===n.data.users.length)return{token:r().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},u,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=n.data.users.find(t=>t.email===e);return a&&await s().compare(t,a.passwordHash)?{token:r().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},u,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function m(e,t){if(0===(await (0,i.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let n=e.cookies.get(c)?.value;if(!n)return null;try{let e=r().verify(n,u);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,n)=>{let a;n.r(t),n.d(t,{addDays:()=>E,calculateMemberDebt:()=>A,calculatePaidAmountForDebit:()=>I,computeQuote:()=>$,convertNoSocioToSocio:()=>d,endOfMonth:()=>j,formatCurrency:()=>N,getDb:()=>c,getMemberStatus:()=>T,hasReservationConflict:()=>D,nextCollectorCode:()=>m,nextCommissionId:()=>b,nextFamilyId:()=>p,nextFinancingId:()=>f,nextMemberCode:()=>l,nextMovementId:()=>S,nextPaymentId:()=>g,nextRefinancingId:()=>y,nextReservationId:()=>w,nextReservationPaymentId:()=>v,nextResourceId:()=>h,nextSubscriptionId:()=>x,startOfMonth:()=>q,toISODate:()=>R,yyyymm:()=>C});var r=n(26411),o=n(92048),s=n.n(o),i=n(55315),u=n.n(i);function c(){if(!a){let e=function(){let e=u().join(process.cwd(),"data");return s().existsSync(e)||s().mkdirSync(e,{recursive:!0}),u().join(e,"db.json")}();a=(0,r.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function l(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function d(e){let t=await c(),n=t.data.members.findIndex(t=>t.id===e);if(-1===n)throw Error("Member not found");let a=t.data.members[n];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let r=await l();return t.data.members[n]={...a,codigo:r,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[n]}async function m(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function g(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function f(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function b(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function h(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function v(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function x(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function $(e,t,n,a,r=0){let o=e.data.resources.find(e=>e.id===t),s=o?.precioBaseHora??0,i=new Date(n).getTime(),u=Math.max(1,Math.ceil((new Date(a).getTime()-i)/36e5)),c=s*u;return r>100&&(c=Math.round(1.05*c)),{horas:u,monto:c}}function D(e,t,n,a,r){let o=new Date(n).getTime(),s=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==r&&Math.max(new Date(e.start).getTime(),o)<Math.min(new Date(e.end).getTime(),s)&&"CANCELADO"!==e.status)}function N(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function I(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let n=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(n+=Number(t.amount||0));return n}function A(e,t){let a=0;for(let n of t)if(n.memberId===e.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let e=I(n,t),r=n.monto-e;r>0&&(a+=r)}let r=n(9487),o=0;try{for(let t of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))o+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=o)}function T(e,t){return A(e,t)>0?"ATRASADO":"AL_DIA"}function R(e){let t="string"==typeof e?new Date(e):e,n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}function E(e,t){let n=new Date("string"==typeof e?e:e.getTime());return n.setDate(n.getDate()+t),n}function q(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function j(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function C(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},92906:(e,t,n)=>{n.d(t,{LJ:()=>o,tF:()=>r});let a={name:"America/Asuncion"};function r(){let e=new Date,t=Object.fromEntries(new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).formatToParts(e).map(e=>[e.type,e.value]));return new Date(parseInt(t.year),parseInt(t.month)-1,parseInt(t.day),parseInt(t.hour),parseInt(t.minute),parseInt(t.second))}function o(e){if(e){let t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${a}`}{let e=new Date;return new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit"}).format(e)}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>n(11109));module.exports=a})();