"use strict";(()=>{var e={};e.id=5861,e.ids=[5861],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},52550:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>I,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>S,staticGenerationAsyncStorage:()=>v});var r={};n.r(r),n.d(r,{GET:()=>b,POST:()=>D,dynamic:()=>l});var a=n(49303),i=n(88716),o=n(60670),s=n(87070),u=n(9487),c=n(40259),m=n(90455);let l="force-dynamic";function d(e){e.data.movements||=[]}function p(e){if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return new Date(`${e}T00:00:00.000Z`).toISOString();let t=new Date(e);return Number.isNaN(t.getTime())?new Date().toISOString():t.toISOString()}function f(e){let t=String(e||"").trim().toUpperCase();return"DEBIT"===t||"DEBE"===t?"DEBIT":"CREDIT"===t||"HABER"===t?"CREDIT":null}function g(e,t,n){let r=Number(e),a=Number.isFinite(r)&&r>0?Math.floor(r):t;return"number"==typeof n?Math.min(a,n):a}function w(e){if("DEBIT"!==e.tipo)return;let t=Number(e.paidAmount||0),n=Number(e.monto||0);e.status=t<=0?"PENDIENTE":t>=n?"CANCELADO":"PARCIAL"}async function b(e,{params:t}){if(!await (0,m.mk)(e,["admin","caja","consulta"]))return s.NextResponse.json({ok:!1},{status:401});try{let n=await (0,u.getDb)();d(n);let r=new URL(e.url),a=t.id,i=r.searchParams.get("from"),o=r.searchParams.get("to"),c=(r.searchParams.get("type")||r.searchParams.get("tipo")||"ALL").toUpperCase(),m=(r.searchParams.get("q")||r.searchParams.get("search")||"").trim().toLowerCase(),l=(r.searchParams.get("status")||"ALL").toUpperCase(),p=Math.max(1,g(r.searchParams.get("page"),1)),b=g(r.searchParams.get("pageSize"),10,100),D=n.data.movements.filter(e=>e.memberId===a);if("REFINANCIADO"!==l&&(D=D.filter(e=>!("DEBIT"===e.tipo&&"REFINANCIADO"===e.status))),D=D.map(e=>{let t=f(e.tipo);return{...e,tipo:t||"DEBIT"}}),i){let e=new Date(i);D=D.filter(t=>new Date(t.fecha)>=e)}if(o){let e=function(e){let t=new Date(e);return t.setHours(23,59,59,999),t}(new Date(o));D=D.filter(t=>new Date(t.fecha)<=e)}if("ALL"!==c){let e=f(c);e&&(D=D.filter(t=>t.tipo===e))}m&&(D=D.filter(e=>{let t=(e.concepto||"").toLowerCase(),n=(e.observaciones||"").toLowerCase();return t.includes(m)||n.includes(m)})),D=D.map(e=>("DEBIT"===e.tipo&&w(e),e)),("PENDIENTE"===l||"PARCIAL"===l||"CANCELADO"===l||"REFINANCIADO"===l)&&(D=D.filter(e=>"DEBIT"===e.tipo&&e.status===l)),D.sort((e,t)=>new Date(e.fecha).getTime()-new Date(t.fecha).getTime());let y=D.length,h=D.filter(e=>"DEBIT"===e.tipo).reduce((e,t)=>e+(t.monto||0),0),v=D.filter(e=>"CREDIT"===e.tipo).reduce((e,t)=>e+(t.monto||0),0),S=Math.max(1,Math.ceil(y/b)),I=Math.min(p,S),A=(I-1)*b,x=D.slice(A,A+b);return s.NextResponse.json({items:x,page:I,pageSize:b,total:y,totalPages:S,totals:{debe:h,haber:v,saldo:h-v}})}catch(e){return console.error("GET /movements error",e),s.NextResponse.json({msg:e?.message||"Error al obtener movimientos"},{status:500})}}async function D(e,{params:t}){if(!await (0,m.mk)(e,["admin","caja"]))return s.NextResponse.json({ok:!1},{status:401});try{let n=await (0,u.getDb)();d(n);let r=t.id,a=await e.json(),i=String(a.concepto||"").trim(),o=f(a.tipo),m=Number(a.monto),l=p(a.fecha||new Date),g=a.origen,b=a.refId?String(a.refId):void 0,D=a.observaciones?String(a.observaciones):void 0,y=a.vencimiento?"string"==typeof a.vencimiento&&/^\d{4}-\d{2}-\d{2}$/.test(a.vencimiento)?`${a.vencimiento}T00:00:00.000Z`:p(a.vencimiento):void 0;if(!i||!o||!Number.isFinite(m)||m<=0)return s.NextResponse.json({msg:"Datos inv\xe1lidos. Requeridos: concepto, tipo (DEBIT/DEBE/CREDIT/HABER), monto > 0."},{status:400});let h={id:(0,c.x0)(),memberId:r,concepto:i,tipo:o,monto:m,fecha:l,...g?{origen:g}:{},...b?{refId:b}:{},...D?{observaciones:D}:{},...y?{vencimiento:y}:{}};return"DEBIT"===h.tipo&&(h.paidAmount=Number(h.paidAmount||0),w(h)),n.data.movements.push(h),await n.write(),s.NextResponse.json(h,{status:201})}catch(e){return console.error("POST /movements error",e),s.NextResponse.json({msg:e?.message||"Error al crear movimiento"},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/members/[id]/movements/route",pathname:"/api/members/[id]/movements",filename:"route",bundlePath:"app/api/members/[id]/movements/route"},resolvedPagePath:"C:\\Garden\\app\\api\\members\\[id]\\movements\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:v,serverHooks:S}=y,I="/api/members/[id]/movements/route";function A(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:v})}},90455:(e,t,n)=>{n.d(t,{B$:()=>c,hm:()=>m,mk:()=>d,zB:()=>l});var r=n(41482),a=n.n(r),i=n(42023),o=n.n(i),s=n(9487);let u=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function m(){return 0===(await (0,s.getDb)()).data.users.length}async function l(e,t){let n=await (0,s.getDb)();if(0===n.data.users.length)return{token:a().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},u,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let r=n.data.users.find(t=>t.email===e);return r&&await o().compare(t,r.passwordHash)?{token:a().sign({sub:r.id,rol:r.rol,nombre:r.nombre,email:r.email},u,{expiresIn:"8h"}),user:{email:r.email,rol:r.rol,nombre:r.nombre}}:null}async function d(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let n=e.cookies.get(c)?.value;if(!n)return null;try{let e=a().verify(n,u);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,n)=>{let r;n.r(t),n.d(t,{addDays:()=>N,calculateMemberDebt:()=>q,calculatePaidAmountForDebit:()=>E,computeQuote:()=>I,convertNoSocioToSocio:()=>l,endOfMonth:()=>P,formatCurrency:()=>x,getDb:()=>c,getMemberStatus:()=>T,hasReservationConflict:()=>A,nextCollectorCode:()=>d,nextCommissionId:()=>w,nextFamilyId:()=>f,nextFinancingId:()=>g,nextMemberCode:()=>m,nextMovementId:()=>v,nextPaymentId:()=>p,nextRefinancingId:()=>S,nextReservationId:()=>D,nextReservationPaymentId:()=>y,nextResourceId:()=>b,nextSubscriptionId:()=>h,startOfMonth:()=>R,toISODate:()=>C,yyyymm:()=>M});var a=n(26411),i=n(92048),o=n.n(i),s=n(55315),u=n.n(s);function c(){if(!r){let e=function(){let e=u().join(process.cwd(),"data");return o().existsSync(e)||o().mkdirSync(e,{recursive:!0}),u().join(e,"db.json")}();r=(0,a.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return r}async function m(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function l(e){let t=await c(),n=t.data.members.findIndex(t=>t.id===e);if(-1===n)throw Error("Member not found");let r=t.data.members[n];if("NO SOCIO"!==r.subcategoria)throw Error("Member is not a no-socio");let a=await m();return t.data.members[n]={...r,codigo:a,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[n]}async function d(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function p(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function f(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function b(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function D(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function h(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function v(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function I(e,t,n,r,a=0){let i=e.data.resources.find(e=>e.id===t),o=i?.precioBaseHora??0,s=new Date(n).getTime(),u=Math.max(1,Math.ceil((new Date(r).getTime()-s)/36e5)),c=o*u;return a>100&&(c=Math.round(1.05*c)),{horas:u,monto:c}}function A(e,t,n,r,a){let i=new Date(n).getTime(),o=new Date(r).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==a&&Math.max(new Date(e.start).getTime(),i)<Math.min(new Date(e.end).getTime(),o)&&"CANCELADO"!==e.status)}function x(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function E(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let n=0;for(let r of t)if(r.allocations&&Array.isArray(r.allocations))for(let t of r.allocations)t.debitId===e.id&&(n+=Number(t.amount||0));return n}function q(e,t){let r=0;for(let n of t)if(n.memberId===e.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let e=E(n,t),a=n.monto-e;a>0&&(r+=a)}let a=n(9487),i=0;try{for(let t of(a.getDb&&"function"==typeof a.getDb&&a.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))i+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,r-=i)}function T(e,t){return q(e,t)>0?"ATRASADO":"AL_DIA"}function C(e){let t="string"==typeof e?new Date(e):e,n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${a}`}function N(e,t){let n=new Date("string"==typeof e?e:e.getTime());return n.setDate(n.getDate()+t),n}function R(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function P(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function M(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},40259:(e,t,n)=>{let r,a;n.d(t,{x0:()=>o});let i=require("node:crypto");function o(e=21){var t;t=e-=0,!r||r.length<t?(r=Buffer.allocUnsafe(128*t),i.webcrypto.getRandomValues(r),a=0):a+t>r.length&&(i.webcrypto.getRandomValues(r),a=0),a+=t;let n="";for(let t=a-e;t<a;t++)n+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&r[t]];return n}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[8948,5972,1482,4565],()=>n(52550));module.exports=r})();