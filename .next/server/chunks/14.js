"use strict";exports.id=14,exports.ids=[14],exports.modules={90455:(e,t,a)=>{a.d(t,{B$:()=>u,hm:()=>d,mk:()=>m,zB:()=>l});var n=a(41482),i=a.n(n),r=a(42023),o=a.n(r),s=a(9487);let c=process.env.JWT_SECRET||"dev-secret",u="gcp_token";async function d(){return 0===(await (0,s.getDb)()).data.users.length}async function l(e,t){let a=await (0,s.getDb)();if(0===a.data.users.length)return{token:i().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},c,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let n=a.data.users.find(t=>t.email===e);return n&&await o().compare(t,n.passwordHash)?{token:i().sign({sub:n.id,rol:n.rol,nombre:n.nombre,email:n.email},c,{expiresIn:"8h"}),user:{email:n.email,rol:n.rol,nombre:n.nombre}}:null}async function m(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let a=e.cookies.get(u)?.value;if(!a)return null;try{let e=i().verify(a,c);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,a)=>{let n;a.r(t),a.d(t,{addDays:()=>O,calculateMemberDebt:()=>E,calculatePaidAmountForDebit:()=>M,computeQuote:()=>h,convertNoSocioToSocio:()=>l,endOfMonth:()=>$,formatCurrency:()=>A,getDb:()=>u,getMemberStatus:()=>C,hasReservationConflict:()=>x,nextCollectorCode:()=>m,nextCommissionId:()=>g,nextFamilyId:()=>p,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>v,nextPaymentId:()=>f,nextRefinancingId:()=>I,nextReservationId:()=>D,nextReservationPaymentId:()=>S,nextResourceId:()=>b,nextSubscriptionId:()=>y,startOfMonth:()=>R,toISODate:()=>T,yyyymm:()=>q});var i=a(26411),r=a(92048),o=a.n(r),s=a(55315),c=a.n(s);function u(){if(!n){let e=function(){let e=c().join(process.cwd(),"data");return o().existsSync(e)||o().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();n=(0,i.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function d(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function l(e){let t=await u(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let n=t.data.members[a];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let i=await d();return t.data.members[a]={...n,codigo:i,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function m(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function w(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function g(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function b(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function D(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function y(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function v(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function I(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function h(e,t,a,n,i=0){let r=e.data.resources.find(e=>e.id===t),o=r?.precioBaseHora??0,s=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(n).getTime()-s)/36e5)),u=o*c;return i>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function x(e,t,a,n,i){let r=new Date(a).getTime(),o=new Date(n).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==i&&Math.max(new Date(e.start).getTime(),r)<Math.min(new Date(e.end).getTime(),o)&&"CANCELADO"!==e.status)}function A(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function M(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let n of t)if(n.allocations&&Array.isArray(n.allocations))for(let t of n.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function E(e,t){let n=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=M(a,t),i=a.monto-e;i>0&&(n+=i)}let i=a(9487),r=0;try{for(let t of(i.getDb&&"function"==typeof i.getDb&&i.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))r+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,n-=r)}function C(e,t){return E(e,t)>0?"ATRASADO":"AL_DIA"}function T(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${n}-${i}`}function O(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function R(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function $(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function q(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},75747:(e,t,a)=>{a.d(t,{Fd:()=>s,Nc:()=>r,T6:()=>d,Tx:()=>c,h2:()=>i,i7:()=>u,oM:()=>o});var n=a(9487);async function i(e,t,a){let i=await (0,n.getDb)(),r=await (0,n.nextMovementId)(),o={id:r,memberId:e,fecha:new Date().toISOString(),concepto:`Penalizaci\xf3n por cancelaci\xf3n de Reserva #${t}`,tipo:"DEBIT",monto:Math.abs(a),origen:"AJUSTE",refId:t,observaciones:`D\xe9bito de penalizaci\xf3n: club retiene ${a} Gs. por cancelaci\xf3n con reembolso parcial (pago contado).`,status:"CANCELADO",paidAmount:Math.abs(a)};return i.data.movements.push(o),await i.write(),r}async function r(e,t,a){let i=await (0,n.getDb)(),r=await (0,n.nextMovementId)(),o={id:r,memberId:e,fecha:new Date().toISOString(),concepto:`Reembolso parcial al socio - Reserva #${t}`,tipo:"DEBIT",monto:Math.abs(a),origen:"REEMBOLSO",refId:t,observaciones:`Egreso por reembolso parcial de ${a} Gs. al socio por cancelaci\xf3n de reserva.`,status:"CANCELADO",paidAmount:Math.abs(a)};return i.data.movements.push(o),await i.write(),r}async function o(e,t){let a=await (0,n.getDb)(),i=0;for(let e of a.data.movements.filter(e=>"CREDIT"===e.tipo&&!!e.allocations&&0!==e.allocations.length&&e.allocations.some(e=>t.includes(e.debitId||"")))){let t=a.data.movements.findIndex(t=>t.id===e.id);-1!==t&&(a.data.movements.splice(t,1),i++)}return await a.write(),i}async function s(e,t,a,i){let r=await (0,n.getDb)(),o=await (0,n.nextMovementId)(),s=i.length>0?Math.abs(a)/i.length:0,c=i.map(e=>({debitId:e,amount:s})),u={id:o,memberId:e,fecha:new Date().toISOString(),concepto:`Nota de Cr\xe9dito por cancelaci\xf3n de Reserva #${t}`,tipo:"CREDIT",monto:Math.abs(a),origen:"AJUSTE",refId:t,observaciones:`Nota de cr\xe9dito emitida para anulaci\xf3n contable de reserva.`,status:"CANCELADO",paidAmount:Math.abs(a),allocations:c.length>0?c:void 0};return r.data.movements.push(u),await r.write(),o}async function c(e,t,a,i=!0){let r;let o=await (0,n.getDb)(),s=await (0,n.nextMovementId)(),c={id:s,memberId:e,fecha:new Date().toISOString(),concepto:`Penalizaci\xf3n por cancelaci\xf3n de Reserva #${t}`,tipo:"DEBIT",monto:Math.abs(a),origen:"AJUSTE",refId:t,observaciones:`D\xe9bito de penalizaci\xf3n: club retiene ${a} Gs. por cancelaci\xf3n sin reembolso.`,status:"CANCELADO",paidAmount:Math.abs(a)};if(o.data.movements.push(c),await o.write(),i){let i={id:r=await (0,n.nextMovementId)(),memberId:e,fecha:new Date().toISOString(),concepto:`Compensaci\xf3n de penalizaci\xf3n - Reserva #${t}`,tipo:"CREDIT",monto:Math.abs(a),origen:"AJUSTE",refId:t,observaciones:`Cr\xe9dito de compensaci\xf3n para balancear penalizaci\xf3n (no disponible para socio).`,status:"CANCELADO",paidAmount:Math.abs(a),allocations:[{debitId:s,amount:Math.abs(a)}]};o.data.movements.push(i),await o.write()}return{debitId:s,creditId:r}}async function u(e,t){let a=await (0,n.getDb)();for(let n of t){let t=a.data.movements.find(e=>e.id===n);t&&"DEBIT"===t.tipo&&(t.status="ANULADO",t.paidAmount=t.monto,t.cancelledDueToReservationId=e,t.observaciones=(t.observaciones||"")+` | Anulado por cancelaci\xf3n de Reserva #${e} el ${new Date().toISOString().split("T")[0]}`)}await a.write()}async function d(e){return(await (0,n.getDb)()).data.movements.filter(t=>t.memberId===e&&"CREDIT"===t.tipo&&"NOTA_CREDITO"===t.origen&&"PENDIENTE"===t.status).reduce((e,t)=>e+(t.monto||0),0)}}};