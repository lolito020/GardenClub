"use strict";(()=>{var e={};e.id=8444,e.ids=[8444],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},95055:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>y,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g});var a={};n.r(a),n.d(a,{POST:()=>l,dynamic:()=>d});var r=n(49303),i=n(88716),o=n(60670),s=n(87070),c=n(9487),u=n(40259),m=n(90455);let d="force-dynamic";async function l(e){if(!await (0,m.mk)(e,["admin","caja"]))return s.NextResponse.json({ok:!1},{status:401});try{let t=await (0,c.getDb)();t.data.members||=[],t.data.payments||=[],t.data.movements||=[];let n=await e.json().catch(()=>({})),a=n?.memberId?String(n.memberId):null,r=t.data.payments.filter(e=>!a||e.memberId===a),i=0,o=0,m=new Set(t.data.movements.filter(e=>"PAGO"===e.origen&&e.refId).map(e=>`${e.memberId}:${e.refId}`));for(let e of r){let n=`${e.memberId}:${e.id}`;if(m.has(n)){o++;continue}let a=e.concepto&&String(e.concepto).trim()||`Pago${e.formaPago?" "+e.formaPago:""}${e.numeroRecibo?` â€¢ Recibo ${e.numeroRecibo}`:""}`;t.data.movements.push({id:(0,u.x0)(),memberId:e.memberId,fecha:new Date(e.fecha||new Date).toISOString(),concepto:a,tipo:"CREDIT",monto:Number(e.monto)||0,origen:"PAGO",refId:String(e.id)}),m.add(n),i++}return await t.write(),s.NextResponse.json({ok:!0,processed:r.length,created:i,skipped:o,scope:a?{memberId:a}:"all"})}catch(e){return console.error("reconcile-payment-movements error",e),s.NextResponse.json({ok:!1,msg:e?.message||"Error en conciliaci\xf3n"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/maintenance/reconcile-payment-movements/route",pathname:"/api/maintenance/reconcile-payment-movements",filename:"route",bundlePath:"app/api/maintenance/reconcile-payment-movements/route"},resolvedPagePath:"C:\\Garden\\app\\api\\maintenance\\reconcile-payment-movements\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:w}=p,y="/api/maintenance/reconcile-payment-movements/route";function b(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},90455:(e,t,n)=>{n.d(t,{B$:()=>u,hm:()=>m,mk:()=>l,zB:()=>d});var a=n(41482),r=n.n(a),i=n(42023),o=n.n(i),s=n(9487);let c=process.env.JWT_SECRET||"dev-secret",u="gcp_token";async function m(){return 0===(await (0,s.getDb)()).data.users.length}async function d(e,t){let n=await (0,s.getDb)();if(0===n.data.users.length)return{token:r().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},c,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=n.data.users.find(t=>t.email===e);return a&&await o().compare(t,a.passwordHash)?{token:r().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},c,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let n=e.cookies.get(u)?.value;if(!n)return null;try{let e=r().verify(n,c);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,n)=>{let a;n.r(t),n.d(t,{addDays:()=>$,calculateMemberDebt:()=>P,calculatePaidAmountForDebit:()=>A,computeQuote:()=>I,convertNoSocioToSocio:()=>d,endOfMonth:()=>O,formatCurrency:()=>D,getDb:()=>u,getMemberStatus:()=>R,hasReservationConflict:()=>q,nextCollectorCode:()=>l,nextCommissionId:()=>w,nextFamilyId:()=>f,nextFinancingId:()=>g,nextMemberCode:()=>m,nextMovementId:()=>h,nextPaymentId:()=>p,nextRefinancingId:()=>x,nextReservationId:()=>b,nextReservationPaymentId:()=>S,nextResourceId:()=>y,nextSubscriptionId:()=>v,startOfMonth:()=>C,toISODate:()=>M,yyyymm:()=>T});var r=n(26411),i=n(92048),o=n.n(i),s=n(55315),c=n.n(s);function u(){if(!a){let e=function(){let e=c().join(process.cwd(),"data");return o().existsSync(e)||o().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();a=(0,r.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function m(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function d(e){let t=await u(),n=t.data.members.findIndex(t=>t.id===e);if(-1===n)throw Error("Member not found");let a=t.data.members[n];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let r=await m();return t.data.members[n]={...a,codigo:r,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[n]}async function l(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function p(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function f(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function w(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function y(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function b(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function v(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function h(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function x(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function I(e,t,n,a,r=0){let i=e.data.resources.find(e=>e.id===t),o=i?.precioBaseHora??0,s=new Date(n).getTime(),c=Math.max(1,Math.ceil((new Date(a).getTime()-s)/36e5)),u=o*c;return r>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function q(e,t,n,a,r){let i=new Date(n).getTime(),o=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==r&&Math.max(new Date(e.start).getTime(),i)<Math.min(new Date(e.end).getTime(),o)&&"CANCELADO"!==e.status)}function D(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function A(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let n=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(n+=Number(t.amount||0));return n}function P(e,t){let a=0;for(let n of t)if(n.memberId===e.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let e=A(n,t),r=n.monto-e;r>0&&(a+=r)}let r=n(9487),i=0;try{for(let t of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))i+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=i)}function R(e,t){return P(e,t)>0?"ATRASADO":"AL_DIA"}function M(e){let t="string"==typeof e?new Date(e):e,n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}function $(e,t){let n=new Date("string"==typeof e?e:e.getTime());return n.setDate(n.getDate()+t),n}function C(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function O(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function T(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},40259:(e,t,n)=>{let a,r;n.d(t,{x0:()=>o});let i=require("node:crypto");function o(e=21){var t;t=e-=0,!a||a.length<t?(a=Buffer.allocUnsafe(128*t),i.webcrypto.getRandomValues(a),r=0):r+t>a.length&&(i.webcrypto.getRandomValues(a),r=0),r+=t;let n="";for(let t=r-e;t<r;t++)n+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&a[t]];return n}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>n(95055));module.exports=a})();