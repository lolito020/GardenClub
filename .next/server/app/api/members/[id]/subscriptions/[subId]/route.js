"use strict";(()=>{var t={};t.id=9459,t.ids=[9459],t.modules={20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:t=>{t.exports=require("fs")},55315:t=>{t.exports=require("path")},87561:t=>{t.exports=require("node:fs")},93977:t=>{t.exports=require("node:fs/promises")},49411:t=>{t.exports=require("node:path")},41041:t=>{t.exports=require("node:url")},89255:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w});var n={};a.r(n),a.d(n,{DELETE:()=>l,GET:()=>d,PATCH:()=>m});var r=a(49303),i=a(88716),s=a(60670),o=a(87070),c=a(9487);function u(t,e,a){let n=t.memberSubscriptions??[],r=n.findIndex(t=>t.id===a&&t.memberId===e);return{idx:r,item:r>=0?n[r]:void 0}}async function d(t,{params:e}){let{item:a}=u((await (0,c.getDb)()).data,e.id,e.subId);return a?o.NextResponse.json(a):o.NextResponse.json({msg:"No encontrado"},{status:404})}async function m(t,{params:e}){let a=await t.json(),n=await (0,c.getDb)();n.data.memberSubscriptions=n.data.memberSubscriptions??[];let{idx:r,item:i}=u(n.data,e.id,e.subId);if(r<0||!i)return o.NextResponse.json({msg:"No encontrado"},{status:404});let s="ANUAL"===a.periodicity||"MENSUAL"===a.periodicity?a.periodicity:i.periodicity,d={...i,serviceId:a.serviceId??i.serviceId,price:"number"==typeof a.price?a.price:i.price,periodicity:s,cadenceDays:"number"==typeof a.cadenceDays?a.cadenceDays:i.cadenceDays,autoDebit:"boolean"==typeof a.autoDebit?a.autoDebit:i.autoDebit,status:"ACTIVE"===a.status||"PAUSED"===a.status||"CANCELLED"===a.status?a.status:i.status,startDate:a.startDate?(0,c.toISODate)(a.startDate):i.startDate,nextChargeDate:a.nextChargeDate?10===a.nextChargeDate.length&&a.nextChargeDate.match(/^\d{4}-\d{2}-\d{2}$/)?a.nextChargeDate:(0,c.toISODate)(a.nextChargeDate):i.nextChargeDate,notes:"string"==typeof a.notes?a.notes:i.notes};return n.data.memberSubscriptions[r]=d,await n.write(),o.NextResponse.json(d)}async function l(t,{params:e}){let a=await (0,c.getDb)(),n=a.data.memberSubscriptions??[],r=n.filter(t=>!(t.id===e.subId&&t.memberId===e.id));return r.length===n.length?o.NextResponse.json({msg:"No encontrado"},{status:404}):(a.data.memberSubscriptions=r,await a.write(),o.NextResponse.json({ok:!0}))}let p=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/members/[id]/subscriptions/[subId]/route",pathname:"/api/members/[id]/subscriptions/[subId]",filename:"route",bundlePath:"app/api/members/[id]/subscriptions/[subId]/route"},resolvedPagePath:"C:\\Garden\\app\\api\\members\\[id]\\subscriptions\\[subId]\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:h}=p,g="/api/members/[id]/subscriptions/[subId]/route";function y(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},9487:(t,e,a)=>{let n;a.r(e),a.d(e,{addDays:()=>N,calculateMemberDebt:()=>C,calculatePaidAmountForDebit:()=>A,computeQuote:()=>I,convertNoSocioToSocio:()=>m,endOfMonth:()=>R,formatCurrency:()=>q,getDb:()=>u,getMemberStatus:()=>P,hasReservationConflict:()=>v,nextCollectorCode:()=>l,nextCommissionId:()=>h,nextFamilyId:()=>f,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>S,nextPaymentId:()=>p,nextRefinancingId:()=>x,nextReservationId:()=>y,nextReservationPaymentId:()=>b,nextResourceId:()=>g,nextSubscriptionId:()=>D,startOfMonth:()=>M,toISODate:()=>E,yyyymm:()=>O});var r=a(26411),i=a(92048),s=a.n(i),o=a(55315),c=a.n(o);function u(){if(!n){let t=function(){let t=c().join(process.cwd(),"data");return s().existsSync(t)||s().mkdirSync(t,{recursive:!0}),c().join(t,"db.json")}();n=(0,r.cW)(t,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function d(){let t=await u();return t.data.sequences.member+=1,await t.write(),String(t.data.sequences.member)}async function m(t){let e=await u(),a=e.data.members.findIndex(e=>e.id===t);if(-1===a)throw Error("Member not found");let n=e.data.members[a];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let r=await d();return e.data.members[a]={...n,codigo:r,categoria:"Individual",subcategoria:"Socio"},await e.write(),e.data.members[a]}async function l(){let t=await u();return t.data.sequences.collector+=1,await t.write(),`COB-${String(t.data.sequences.collector).padStart(3,"0")}`}async function p(){let t=await u();return t.data.sequences.payment+=1,await t.write(),`PAY-${String(t.data.sequences.payment).padStart(6,"0")}`}async function f(){let t=await u();return t.data.sequences.family+=1,await t.write(),`FAM-${String(t.data.sequences.family).padStart(4,"0")}`}async function w(){let t=await u();return t.data.sequences.financing+=1,await t.write(),`FIN-${String(t.data.sequences.financing).padStart(4,"0")}`}async function h(){let t=await u();return t.data.sequences.commission+=1,await t.write(),`COM-${String(t.data.sequences.commission).padStart(6,"0")}`}async function g(){let t=await u();return t.data.sequences.resource+=1,await t.write(),`RESRC-${String(t.data.sequences.resource).padStart(4,"0")}`}async function y(){let t=await u();return t.data.sequences.reservation+=1,await t.write(),`RES-${String(t.data.sequences.reservation).padStart(6,"0")}`}async function b(){let t=await u();return t.data.sequences.reservationPayment+=1,await t.write(),`RESPAY-${String(t.data.sequences.reservationPayment).padStart(6,"0")}`}async function D(){let t=await u();return t.data.sequences.subscription+=1,await t.write(),`SUB-${String(t.data.sequences.subscription).padStart(6,"0")}`}async function S(){let t=await u();return t.data.sequences.movement+=1,await t.write(),`MOV-${String(t.data.sequences.movement).padStart(6,"0")}`}async function x(){let t=await u();return t.data.sequences.refinancing+=1,await t.write(),`REF-${String(t.data.sequences.refinancing).padStart(6,"0")}`}function I(t,e,a,n,r=0){let i=t.data.resources.find(t=>t.id===e),s=i?.precioBaseHora??0,o=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(n).getTime()-o)/36e5)),u=s*c;return r>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function v(t,e,a,n,r){let i=new Date(a).getTime(),s=new Date(n).getTime();return t.data.reservations.some(t=>t.resourceId===e&&t.id!==r&&Math.max(new Date(t.start).getTime(),i)<Math.min(new Date(t.end).getTime(),s)&&"CANCELADO"!==t.status)}function q(t){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(t)}function A(t,e){if(!t||"DEBIT"!==t.tipo)return 0;let a=0;for(let n of e)if(n.allocations&&Array.isArray(n.allocations))for(let e of n.allocations)e.debitId===t.id&&(a+=Number(e.amount||0));return a}function C(t,e){let n=0;for(let a of e)if(a.memberId===t.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let t=A(a,e),r=a.monto-t;r>0&&(n+=r)}let r=a(9487),i=0;try{for(let e of(r.getDb&&"function"==typeof r.getDb&&r.getDb().data?.refinancings||[]).filter(e=>e.memberId===t.id&&("ACTIVA"===e.status||"APROBADA"===e.status)))i+=Number(e.downPaymentAmount||0)}catch(t){}return Math.max(0,n-=i)}function P(t,e){return C(t,e)>0?"ATRASADO":"AL_DIA"}function E(t){let e="string"==typeof t?new Date(t):t,a=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${n}-${r}`}function N(t,e){let a=new Date("string"==typeof t?t:t.getTime());return a.setDate(a.getDate()+e),a}function M(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth(),1)}function R(t){let e="string"==typeof t?new Date(t):t;return new Date(e.getFullYear(),e.getMonth()+1,0)}function O(t){let e="string"==typeof t?new Date(t):t;return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`}},26411:(t,e,a)=>{a.d(e,{cW:()=>l}),a(87561);var n=a(93977),r=a(49411),i=a(41041);async function s(t,e,a){for(let n=0;n<e;n++)try{return await t()}catch(t){if(n<e-1)await new Promise(t=>setTimeout(t,a));else throw t}}class o{#t;#e;#a=!1;#n=null;#r=null;#i=null;#s=null;#o(t){return this.#s=t,this.#i||=new Promise((t,e)=>{this.#r=[t,e]}),new Promise((t,e)=>{this.#i?.then(t).catch(e)})}async #c(t){this.#a=!0;try{await (0,n.writeFile)(this.#e,t,"utf-8"),await s(async()=>{await (0,n.rename)(this.#e,this.#t)},10,100),this.#n?.[0]()}catch(t){throw t instanceof Error&&this.#n?.[1](t),t}finally{if(this.#a=!1,this.#n=this.#r,this.#r=this.#i=null,null!==this.#s){let t=this.#s;this.#s=null,await this.write(t)}}}constructor(t){this.#t=t,this.#e=function(t){let e=t instanceof URL?(0,i.fileURLToPath)(t):t.toString();return(0,r.join)((0,r.dirname)(e),`.${(0,r.basename)(e)}.tmp`)}(t)}async write(t){return this.#a?this.#o(t):this.#c(t)}}class c{#t;#u;constructor(t){this.#t=t,this.#u=new o(t)}async read(){let t;try{t=await (0,n.readFile)(this.#t,"utf-8")}catch(t){if("ENOENT"===t.code)return null;throw t}return t}write(t){return this.#u.write(t)}}class u{#d;#m;#l;constructor(t,{parse:e,stringify:a}){this.#d=new c(t),this.#m=e,this.#l=a}async read(){let t=await this.#d.read();return null===t?null:this.#m(t)}write(t){return this.#d.write(this.#l(t))}}class d extends u{constructor(t){super(t,{parse:JSON.parse,stringify:t=>JSON.stringify(t,null,2)})}}class m{adapter;data;constructor(t,e){(function(t,e){if(void 0===t)throw Error("lowdb: missing adapter");if(void 0===e)throw Error("lowdb: missing default data")})(t,e),this.adapter=t,this.data=e}async read(){let t=await this.adapter.read();t&&(this.data=t)}async write(){this.data&&await this.adapter.write(this.data)}async update(t){t(this.data),await this.write()}}async function l(t,e){let a=new m(new d(t),e);return await a.read(),a}}};var e=require("../../../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),n=e.X(0,[8948,5972],()=>a(89255));module.exports=n})();