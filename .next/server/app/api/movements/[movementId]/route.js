"use strict";(()=>{var e={};e.id=5137,e.ids=[5137],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},31881:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>b,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var a={};n.r(a),n.d(a,{DELETE:()=>p,GET:()=>l,PATCH:()=>f,dynamic:()=>u});var o=n(49303),r=n(88716),i=n(60670),s=n(87070),m=n(9487),c=n(90455);let u="force-dynamic";function d(e){e.data.movements||=[]}async function l(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja","consulta"]))return s.NextResponse.json({ok:!1},{status:401});let n=await (0,m.getDb)();d(n);let a=n.data.movements.find(e=>String(e.id)===String(t.movementId));return a?s.NextResponse.json(a):s.NextResponse.json({ok:!1,msg:"Movimiento no encontrado"},{status:404})}async function f(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja"]))return s.NextResponse.json({ok:!1},{status:401});let n=await (0,m.getDb)();d(n);let a=n.data.movements.findIndex(e=>String(e.id)===String(t.movementId));if(a<0)return s.NextResponse.json({ok:!1,msg:"Movimiento no encontrado"},{status:404});let o=n.data.movements[a];if("PAGO"===o.origen)return s.NextResponse.json({ok:!1,msg:"No se puede editar un movimiento de origen PAGO"},{status:400});let r=await e.json().catch(()=>({})),i={};if(r.fecha){if(!/^\d{4}-\d{2}-\d{2}$/.test(r.fecha))return s.NextResponse.json({ok:!1,msg:"Fecha inv\xe1lida"},{status:400});i.fecha=r.fecha}if("string"==typeof r.concepto&&(i.concepto=r.concepto.trim()),"string"==typeof r.tipo){let e=String(r.tipo).toUpperCase();if(!("DEBIT"===e||"CREDIT"===e))return s.NextResponse.json({ok:!1,msg:"Tipo inv\xe1lido"},{status:400});i.tipo=e}if(null!=r.monto){let e=Number(r.monto);if(!Number.isFinite(e)||e<=0)return s.NextResponse.json({ok:!1,msg:"Monto inv\xe1lido"},{status:400});i.monto=e}if("string"==typeof r.observaciones&&(i.observaciones=r.observaciones.trim()),r.vencimiento){let e=new Date(r.vencimiento+"T00:00:00");if(isNaN(e.getTime()))return s.NextResponse.json({ok:!1,msg:"Vencimiento inv\xe1lido"},{status:400});i.vencimiento=e.toISOString().slice(0,10)}return n.data.movements[a]={...o,...i},await n.write(),s.NextResponse.json(n.data.movements[a])}async function p(e,{params:t}){if(!await (0,c.mk)(e,["admin","caja"]))return s.NextResponse.json({ok:!1},{status:401});let n=await (0,m.getDb)();d(n);let a=n.data.movements.findIndex(e=>String(e.id)===String(t.movementId));if(a<0)return s.NextResponse.json({ok:!1,msg:"Movimiento no encontrado"},{status:404});let o=n.data.movements[a];if("PAGO"===o.origen)return s.NextResponse.json({ok:!1,msg:"No se puede eliminar un movimiento de origen PAGO"},{status:400});if("DEBIT"===o.tipo){let t=n.data.movements.filter(e=>"CREDIT"===e.tipo&&Array.isArray(e.allocations)&&e.allocations.some(e=>e.debitId===o.id)),a=n.data.payments?n.data.payments.filter(e=>Array.isArray(e.allocations)&&e.allocations.some(e=>e.debitId===o.id)):[],r="true"===e.nextUrl.searchParams.get("cascade"),i=t.length+a.length;if(i>0&&!r){let e=[...t.map(e=>({id:e.id,fecha:e.fecha,concepto:e.concepto,monto:e.monto,tipo:"CREDIT"})),...a.map(e=>({id:e.id,fecha:e.fecha,concepto:e.concepto,monto:e.monto,tipo:"PAYMENT"}))],n=new Map;for(let t of e){let e=`${t.fecha}-${t.concepto}-${t.monto}`;n.has(e)||n.set(e,t)}return s.NextResponse.json({ok:!1,msg:"Este d\xe9bito tiene pagos (HABER) asociados. \xbfDesea eliminar tambi\xe9n los pagos relacionados?",relatedCredits:Array.from(n.values())},{status:409})}if(i>0&&r){let e=[],r=[];for(let n of t)Array.isArray(n.allocations)&&(n.allocations=n.allocations.filter(e=>e.debitId!==o.id)),n.allocations&&0!==n.allocations.length||e.push(n.id);for(let e of a)Array.isArray(e.allocations)&&(e.allocations=e.allocations.filter(e=>e.debitId!==o.id)),e.allocations&&0!==e.allocations.length||r.push(e.id);for(let t of e){let e=n.data.movements.findIndex(e=>e.id===t);e>=0&&n.data.movements.splice(e,1)}for(let e of r){let t=n.data.payments?n.data.payments.findIndex(t=>t.id===e):-1;t>=0&&n.data.payments&&n.data.payments.splice(t,1)}}}let r=n.data.movements.findIndex(e=>String(e.id)===String(t.movementId));for(let e of(r>=0&&n.data.movements.splice(r,1),n.data.movements))Array.isArray(e.allocations)&&(e.allocations=e.allocations.filter(e=>e.debitId!==t.movementId&&e.creditMovementId!==t.movementId));if(n.data.payments)for(let e of n.data.payments)Array.isArray(e.allocations)&&(e.allocations=e.allocations.filter(e=>e.debitId!==t.movementId&&e.creditMovementId!==t.movementId));return await n.write(),s.NextResponse.json({ok:!0})}let g=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/movements/[movementId]/route",pathname:"/api/movements/[movementId]",filename:"route",bundlePath:"app/api/movements/[movementId]/route"},resolvedPagePath:"C:\\Garden\\app\\api\\movements\\[movementId]\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:w}=g,b="/api/movements/[movementId]/route";function x(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},90455:(e,t,n)=>{n.d(t,{B$:()=>c,hm:()=>u,mk:()=>l,zB:()=>d});var a=n(41482),o=n.n(a),r=n(42023),i=n.n(r),s=n(9487);let m=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function u(){return 0===(await (0,s.getDb)()).data.users.length}async function d(e,t){let n=await (0,s.getDb)();if(0===n.data.users.length)return{token:o().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},m,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=n.data.users.find(t=>t.email===e);return a&&await i().compare(t,a.passwordHash)?{token:o().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},m,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let n=e.cookies.get(c)?.value;if(!n)return null;try{let e=o().verify(n,m);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,n)=>{let a;n.r(t),n.d(t,{addDays:()=>P,calculateMemberDebt:()=>R,calculatePaidAmountForDebit:()=>q,computeQuote:()=>h,convertNoSocioToSocio:()=>d,endOfMonth:()=>j,formatCurrency:()=>D,getDb:()=>c,getMemberStatus:()=>N,hasReservationConflict:()=>A,nextCollectorCode:()=>l,nextCommissionId:()=>v,nextFamilyId:()=>p,nextFinancingId:()=>g,nextMemberCode:()=>u,nextMovementId:()=>I,nextPaymentId:()=>f,nextRefinancingId:()=>S,nextReservationId:()=>w,nextReservationPaymentId:()=>b,nextResourceId:()=>y,nextSubscriptionId:()=>x,startOfMonth:()=>T,toISODate:()=>M,yyyymm:()=>k});var o=n(26411),r=n(92048),i=n.n(r),s=n(55315),m=n.n(s);function c(){if(!a){let e=function(){let e=m().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),m().join(e,"db.json")}();a=(0,o.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function u(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function d(e){let t=await c(),n=t.data.members.findIndex(t=>t.id===e);if(-1===n)throw Error("Member not found");let a=t.data.members[n];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let o=await u();return t.data.members[n]={...a,codigo:o,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[n]}async function l(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function v(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function b(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function x(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function I(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function h(e,t,n,a,o=0){let r=e.data.resources.find(e=>e.id===t),i=r?.precioBaseHora??0,s=new Date(n).getTime(),m=Math.max(1,Math.ceil((new Date(a).getTime()-s)/36e5)),c=i*m;return o>100&&(c=Math.round(1.05*c)),{horas:m,monto:c}}function A(e,t,n,a,o){let r=new Date(n).getTime(),i=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==o&&Math.max(new Date(e.start).getTime(),r)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function D(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function q(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let n=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(n+=Number(t.amount||0));return n}function R(e,t){let a=0;for(let n of t)if(n.memberId===e.id&&"DEBIT"===n.tipo){if("REFINANCIADO"===n.status||"CANCELADO"===n.status)continue;let e=q(n,t),o=n.monto-e;o>0&&(a+=o)}let o=n(9487),r=0;try{for(let t of(o.getDb&&"function"==typeof o.getDb&&o.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))r+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=r)}function N(e,t){return R(e,t)>0?"ATRASADO":"AL_DIA"}function M(e){let t="string"==typeof e?new Date(e):e,n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${o}`}function P(e,t){let n=new Date("string"==typeof e?e:e.getTime());return n.setDate(n.getDate()+t),n}function T(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function j(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function k(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>n(31881));module.exports=a})();