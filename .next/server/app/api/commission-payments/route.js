"use strict";(()=>{var e={};e.id=8285,e.ids=[8285],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},50929:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>b});var a={};r.r(a),r.d(a,{GET:()=>l,POST:()=>f,dynamic:()=>d,runtime:()=>m});var n=r(49303),o=r(88716),i=r(60670),s=r(87070),c=r(9487),u=r(90455);let d="force-dynamic",m="nodejs";async function l(e){try{if(!await (0,u.mk)(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,c.getDb)(),{searchParams:r}=new URL(e.url),a=r.get("cobradorId"),n=r.get("periodo"),o=r.get("fechaDesde"),i=r.get("fechaHasta"),d=[...t.data.commissionPayments];a&&(d=d.filter(e=>e.cobradorId===a)),n&&(d=d.filter(e=>e.periodo===n)),o&&(d=d.filter(e=>e.fecha>=o)),i&&(d=d.filter(e=>e.fecha<=i));let m=d.sort((e,t)=>new Date(t.fecha).getTime()-new Date(e.fecha).getTime()).map(e=>{let r=t.data.collectors.find(t=>t.id===e.cobradorId);return{...e,cobradorNombre:r?`${r.nombres} ${r.apellidos}`:"Cobrador desconocido",cobradorCodigo:r?.codigo||"",cantidadPagos:e.paymentIds?.length||0}});return s.NextResponse.json(m)}catch(e){return console.error("Error al obtener liquidaciones:",e),s.NextResponse.json({error:"Error al obtener liquidaciones"},{status:500})}}async function f(e){try{if(!await (0,u.mk)(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,c.getDb)(),{cobradorId:r,paymentIds:a,formaPago:n,fecha:o,numeroRecibo:i,observaciones:d}=await e.json();if(!r||!Array.isArray(a)||0===a.length||!n)return s.NextResponse.json({error:"Datos incompletos. Se requiere: cobradorId, paymentIds (array no vac\xedo), formaPago"},{status:400});let m=t.data.collectors.find(e=>e.id===r);if(!m)return s.NextResponse.json({error:"Cobrador no encontrado"},{status:404});let l=a.map(e=>{let a=t.data.payments.find(t=>t.id===e);if(!a)throw Error(`Pago ${e} no encontrado`);if(a.cobradorId!==r)throw Error(`Pago ${e} no pertenece al cobrador ${r}`);if(a.comisionPagada)throw Error(`Pago ${e} ya fue liquidado anteriormente`);let n=a.comisionCobrador||0;if(n<=0&&(a.allocations&&a.allocations.length>0&&(n=a.allocations.reduce((e,r)=>{if(r.debitId){let a=t.data.movements.find(e=>e.id===r.debitId);if(a&&a.refId){let n=t.data.services.find(e=>e.id===a.refId);if(n){let t=void 0!==n.comisionCobrador?n.comisionCobrador:m.comisionPorDefecto||0;return e+r.amount*t/100}}}return e},0)),n<=0)){let e=m.comisionPorDefecto||0;n=a.monto*e/100}if(n<=0)throw Error(`Pago ${e} no tiene comisi\xf3n calculable (monto: $${a.monto})`);return{...a,comisionCobrador:n}}),f=l.reduce((e,t)=>e+(t.comisionCobrador||0),0),p=o||new Date().toISOString().split("T")[0],g=p.slice(0,7);t.data.sequences.commission=(t.data.sequences.commission||0)+1;let b=`CP-${String(t.data.sequences.commission).padStart(6,"0")}`,y={id:b,cobradorId:r,fecha:p,monto:f,concepto:`Liquidaci\xf3n de comisiones - ${g} (${a.length} pago${a.length>1?"s":""})`,formaPago:n,periodo:g,paymentIds:a,numeroRecibo:i||"",observaciones:d||""};a.forEach((e,r)=>{let a=t.data.payments.findIndex(t=>t.id===e);-1!==a&&(t.data.payments[a].comisionPagada=!0,t.data.payments[a].commissionPaymentId=b,t.data.payments[a].comisionCobrador=l[r].comisionCobrador)}),t.data.commissionPayments.push(y),await t.write();let w={...y,cobradorNombre:`${m.nombres} ${m.apellidos}`,cobradorCodigo:m.codigo,cantidadPagos:a.length};return s.NextResponse.json({success:!0,message:"Liquidaci\xf3n creada exitosamente",liquidacion:w})}catch(e){return console.error("Error al crear liquidaci\xf3n:",e),s.NextResponse.json({error:e.message||"Error al crear liquidaci\xf3n"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/commission-payments/route",pathname:"/api/commission-payments",filename:"route",bundlePath:"app/api/commission-payments/route"},resolvedPagePath:"C:\\Garden\\app\\api\\commission-payments\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:b,serverHooks:y}=p,w="/api/commission-payments/route";function h(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:b})}},90455:(e,t,r)=>{r.d(t,{B$:()=>u,hm:()=>d,mk:()=>l,zB:()=>m});var a=r(41482),n=r.n(a),o=r(42023),i=r.n(o),s=r(9487);let c=process.env.JWT_SECRET||"dev-secret",u="gcp_token";async function d(){return 0===(await (0,s.getDb)()).data.users.length}async function m(e,t){let r=await (0,s.getDb)();if(0===r.data.users.length)return{token:n().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},c,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=r.data.users.find(t=>t.email===e);return a&&await i().compare(t,a.passwordHash)?{token:n().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},c,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let r=e.cookies.get(u)?.value;if(!r)return null;try{let e=n().verify(r,c);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,r)=>{let a;r.r(t),r.d(t,{addDays:()=>R,calculateMemberDebt:()=>A,calculatePaidAmountForDebit:()=>P,computeQuote:()=>D,convertNoSocioToSocio:()=>m,endOfMonth:()=>M,formatCurrency:()=>v,getDb:()=>u,getMemberStatus:()=>C,hasReservationConflict:()=>I,nextCollectorCode:()=>l,nextCommissionId:()=>b,nextFamilyId:()=>p,nextFinancingId:()=>g,nextMemberCode:()=>d,nextMovementId:()=>q,nextPaymentId:()=>f,nextRefinancingId:()=>x,nextReservationId:()=>w,nextReservationPaymentId:()=>h,nextResourceId:()=>y,nextSubscriptionId:()=>S,startOfMonth:()=>E,toISODate:()=>$,yyyymm:()=>N});var n=r(26411),o=r(92048),i=r.n(o),s=r(55315),c=r.n(s);function u(){if(!a){let e=function(){let e=c().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();a=(0,n.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function d(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function m(e){let t=await u(),r=t.data.members.findIndex(t=>t.id===e);if(-1===r)throw Error("Member not found");let a=t.data.members[r];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let n=await d();return t.data.members[r]={...a,codigo:n,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[r]}async function l(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function g(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function b(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function y(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function w(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function h(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function q(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function x(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function D(e,t,r,a,n=0){let o=e.data.resources.find(e=>e.id===t),i=o?.precioBaseHora??0,s=new Date(r).getTime(),c=Math.max(1,Math.ceil((new Date(a).getTime()-s)/36e5)),u=i*c;return n>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function I(e,t,r,a,n){let o=new Date(r).getTime(),i=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==n&&Math.max(new Date(e.start).getTime(),o)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function v(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function P(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let r=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(r+=Number(t.amount||0));return r}function A(e,t){let a=0;for(let r of t)if(r.memberId===e.id&&"DEBIT"===r.tipo){if("REFINANCIADO"===r.status||"CANCELADO"===r.status)continue;let e=P(r,t),n=r.monto-e;n>0&&(a+=n)}let n=r(9487),o=0;try{for(let t of(n.getDb&&"function"==typeof n.getDb&&n.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))o+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=o)}function C(e,t){return A(e,t)>0?"ATRASADO":"AL_DIA"}function $(e){let t="string"==typeof e?new Date(e):e,r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${r}-${a}-${n}`}function R(e,t){let r=new Date("string"==typeof e?e:e.getTime());return r.setDate(r.getDate()+t),r}function E(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function N(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>r(50929));module.exports=a})();