"use strict";(()=>{var e={};e.id=7854,e.ids=[7854],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},74147:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>p,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var n={};a.r(n),a.d(n,{POST:()=>c});var i=a(49303),r=a(88716),s=a(60670),o=a(9487);async function c(e){try{let{refinancingId:t,cancelledBy:a="system",preserveInterestFees:n=!1}=await e.json();if(!t)return new Response(JSON.stringify({error:"refinancingId requerido"}),{status:400});let i=await (0,o.getDb)(),r=i.data.refinancings.find(e=>e.id===t);if(!r)return new Response(JSON.stringify({error:"Refinanciaci\xf3n no encontrada"}),{status:404});if("ACTIVA"!==r.status)return new Response(JSON.stringify({error:"Solo se puede anular una refinanciaci\xf3n ACTIVA"}),{status:400});let s=new Date().toISOString(),c=[],u=[],d=r.schedule.map(e=>e.debitMovementId).filter(e=>e);for(let e of i.data.movements)if("CREDIT"===e.tipo&&e.allocations)for(let t of e.allocations)t.debitId&&d.includes(t.debitId)&&(u.push({id:`${e.id}-${t.debitId}`,amount:t.amount,paidAt:e.fecha||s,originalMovementId:e.id,allocatedAmount:t.amount}),c.push(`Cr\xe9dito desasignado: ${t.amount} de ${e.concepto} (${e.fecha})`));for(let e of i.data.movements)"CREDIT"===e.tipo&&e.allocations&&(e.allocations=e.allocations.filter(e=>!e.debitId||!d.includes(e.debitId)));for(let e of r.schedule)if(e.debitMovementId){let t=i.data.movements.findIndex(t=>t.id===e.debitMovementId);-1!==t&&(i.data.movements.splice(t,1),c.push(`Cuota eliminada: #${e.number} - ${e.amount}`))}let l=[];for(let e of r.originalDebitsSnapshot){let t=i.data.movements.find(t=>t.id===e.id);if(t){t.monto=e.monto,t.paidAmount=e.paidAmount,t.vencimiento=e.vencimiento,t.concepto=e.concepto,t.status="PENDIENTE",t.observaciones=(t.observaciones||"").replace(/\[Reemplazado por refinanciaciÃ³n [^\]]+\]/g,"").trim();let a=e.monto-e.paidAmount;l.push({movement:t,originalAmount:e.monto,currentBalance:a,dueDate:e.vencimiento||t.fecha||s}),c.push(`D\xe9bito restaurado: ${e.concepto} - ${e.monto} (saldo: ${a})`)}}l.sort((e,t)=>new Date(e.dueDate).getTime()-new Date(t.dueDate).getTime()),u.sort((e,t)=>new Date(e.paidAt).getTime()-new Date(t.paidAt).getTime());let m=0,f=0;for(let e of u){let t=e.amount,a=i.data.movements.find(t=>t.id===e.originalMovementId);if(a){for(let n of l){if(t<=0)break;if(n.currentBalance<=0)continue;let i=Math.min(t,n.currentBalance);n.movement.paidAmount+=i,n.currentBalance-=i,n.currentBalance<=0&&(n.movement.status="CANCELADO"),a.allocations||(a.allocations=[]),a.allocations.push({debitId:n.movement.id,amount:i,paymentId:e.paidAt}),t-=i,m+=i,c.push(`Reasignado: ${i} a ${n.movement.concepto} (fecha original: ${e.paidAt})`)}t>0&&(f+=t,c.push(`Excedente mantenido como saldo a favor: ${t}`))}}return r.status="ANULADA",r.cancelledAt=s,r.updatedAt=s,r.auditTrail.push({timestamp:s,action:"CANCELLED_WITH_ROLLBACK",userId:a,details:`Refinanciaci\xf3n anulada con rollback completo. ${c.join("; ")}. Total reasignado: ${m}. Excedente: ${f}`}),await i.write(),new Response(JSON.stringify({success:!0,refinancing:r,rollbackSummary:{totalCreditsProcessed:u.length,totalReassigned:m,totalExcess:f,debitsRestored:l.length,auditDetails:c}}),{status:200})}catch(e){return new Response(JSON.stringify({error:e.message||"Error interno"}),{status:500})}}let u=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/refinancing/cancel/route",pathname:"/api/refinancing/cancel",filename:"route",bundlePath:"app/api/refinancing/cancel/route"},resolvedPagePath:"C:\\Garden\\app\\api\\refinancing\\cancel\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:m}=u,f="/api/refinancing/cancel/route";function p(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},9487:(e,t,a)=>{let n;a.r(t),a.d(t,{addDays:()=>P,calculateMemberDebt:()=>$,calculatePaidAmountForDebit:()=>q,computeQuote:()=>A,convertNoSocioToSocio:()=>l,endOfMonth:()=>T,formatCurrency:()=>I,getDb:()=>u,getMemberStatus:()=>C,hasReservationConflict:()=>x,nextCollectorCode:()=>m,nextCommissionId:()=>g,nextFamilyId:()=>p,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>b,nextPaymentId:()=>f,nextRefinancingId:()=>D,nextReservationId:()=>y,nextReservationPaymentId:()=>S,nextResourceId:()=>h,nextSubscriptionId:()=>v,startOfMonth:()=>M,toISODate:()=>R,yyyymm:()=>E});var i=a(26411),r=a(92048),s=a.n(r),o=a(55315),c=a.n(o);function u(){if(!n){let e=function(){let e=c().join(process.cwd(),"data");return s().existsSync(e)||s().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();n=(0,i.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return n}async function d(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function l(e){let t=await u(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let n=t.data.members[a];if("NO SOCIO"!==n.subcategoria)throw Error("Member is not a no-socio");let i=await d();return t.data.members[a]={...n,codigo:i,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function m(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function w(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function g(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function h(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function y(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function v(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function b(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function D(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function A(e,t,a,n,i=0){let r=e.data.resources.find(e=>e.id===t),s=r?.precioBaseHora??0,o=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(n).getTime()-o)/36e5)),u=s*c;return i>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function x(e,t,a,n,i){let r=new Date(a).getTime(),s=new Date(n).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==i&&Math.max(new Date(e.start).getTime(),r)<Math.min(new Date(e.end).getTime(),s)&&"CANCELADO"!==e.status)}function I(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function q(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let n of t)if(n.allocations&&Array.isArray(n.allocations))for(let t of n.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function $(e,t){let n=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=q(a,t),i=a.monto-e;i>0&&(n+=i)}let i=a(9487),r=0;try{for(let t of(i.getDb&&"function"==typeof i.getDb&&i.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))r+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,n-=r)}function C(e,t){return $(e,t)>0?"ATRASADO":"AL_DIA"}function R(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${n}-${i}`}function P(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function T(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function E(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},49303:(e,t,a)=>{e.exports=a(30517)},26411:(e,t,a)=>{a.d(t,{cW:()=>m}),a(87561);var n=a(93977),i=a(49411),r=a(41041);async function s(e,t,a){for(let n=0;n<t;n++)try{return await e()}catch(e){if(n<t-1)await new Promise(e=>setTimeout(e,a));else throw e}}class o{#e;#t;#a=!1;#n=null;#i=null;#r=null;#s=null;#o(e){return this.#s=e,this.#r||=new Promise((e,t)=>{this.#i=[e,t]}),new Promise((e,t)=>{this.#r?.then(e).catch(t)})}async #c(e){this.#a=!0;try{await (0,n.writeFile)(this.#t,e,"utf-8"),await s(async()=>{await (0,n.rename)(this.#t,this.#e)},10,100),this.#n?.[0]()}catch(e){throw e instanceof Error&&this.#n?.[1](e),e}finally{if(this.#a=!1,this.#n=this.#i,this.#i=this.#r=null,null!==this.#s){let e=this.#s;this.#s=null,await this.write(e)}}}constructor(e){this.#e=e,this.#t=function(e){let t=e instanceof URL?(0,r.fileURLToPath)(e):e.toString();return(0,i.join)((0,i.dirname)(t),`.${(0,i.basename)(t)}.tmp`)}(e)}async write(e){return this.#a?this.#o(e):this.#c(e)}}class c{#e;#u;constructor(e){this.#e=e,this.#u=new o(e)}async read(){let e;try{e=await (0,n.readFile)(this.#e,"utf-8")}catch(e){if("ENOENT"===e.code)return null;throw e}return e}write(e){return this.#u.write(e)}}class u{#d;#l;#m;constructor(e,{parse:t,stringify:a}){this.#d=new c(e),this.#l=t,this.#m=a}async read(){let e=await this.#d.read();return null===e?null:this.#l(e)}write(e){return this.#d.write(this.#m(e))}}class d extends u{constructor(e){super(e,{parse:JSON.parse,stringify:e=>JSON.stringify(e,null,2)})}}class l{adapter;data;constructor(e,t){(function(e,t){if(void 0===e)throw Error("lowdb: missing adapter");if(void 0===t)throw Error("lowdb: missing default data")})(e,t),this.adapter=e,this.data=t}async read(){let e=await this.adapter.read();e&&(this.data=e)}async write(){this.data&&await this.adapter.write(this.data)}async update(e){e(this.data),await this.write()}}async function m(e,t){let a=new l(new d(e),t);return await a.read(),a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8948],()=>a(74147));module.exports=n})();