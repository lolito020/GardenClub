"use strict";(()=>{var e={};e.id=7272,e.ids=[7272],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},25930:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>l,dynamic:()=>m});var n=r(49303),i=r(88716),o=r(60670),s=r(87070),u=r(9487),c=r(90455),d=r(92906);let m="force-dynamic";async function l(e){try{let t=await (0,c.mk)(e,["admin","porteria"]);if(!t)return s.NextResponse.json({ok:!1,msg:"No autorizado. Acceso solo para porter\xeda."},{status:401});let r=await (0,u.getDb)(),a=(0,d.tF)(),n=a.toISOString().split("T")[0],i=new Date(a);i.setUTCDate(i.getUTCDate()+1);let o=i.toISOString().split("T")[0],m=r.data.reservations||[],l=m.filter(e=>e.start.split("T")[0]===n&&"CANCELADO"!==e.status),p=m.filter(e=>e.start.split("T")[0]===o&&"CANCELADO"!==e.status),g=e=>e.map(e=>{let t=r.data.resources?.find(t=>t.id===e.resourceId),a=null;if(e.memberId){let t=r.data.members.find(t=>t.id===e.memberId);t&&(a={codigo:t.codigo,nombres:t.nombres,apellidos:t.apellidos,categoria:t.categoria})}return{id:e.id,fecha:e.start.split("T")[0],horaInicio:new Date(e.start).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),horaFin:new Date(e.end).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),espacio:t?.nombre||e.resourceId,nombreContacto:e.nombreContacto,contacto:e.contacto,status:e.status,invitados:e.invitados||0,esParaTercero:e.esParaTercero||!1,terceroNombre:e.terceroNombre,acontecimiento:e.acontecimiento,socio:a,notas:e.notas}}).sort((e,t)=>e.horaInicio.localeCompare(t.horaInicio)),f=g(l),w=g(p),y={today:{total:f.length,porEspacio:f.reduce((e,t)=>(e[t.espacio]=(e[t.espacio]||0)+1,e),{}),porHora:f.reduce((e,t)=>{let r=t.horaInicio.split(":")[0]+":00";return e[r]=(e[r]||0)+1,e},{})},tomorrow:{total:w.length}};return s.NextResponse.json({ok:!0,date:n,today:f,tomorrow:w,stats:y,consultedBy:t.email,timestamp:(0,d.tF)().toISOString()})}catch(e){return console.error("Error in porteria/daily-reservations:",e),s.NextResponse.json({ok:!1,msg:"Error interno del servidor"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/porteria/daily-reservations/route",pathname:"/api/porteria/daily-reservations",filename:"route",bundlePath:"app/api/porteria/daily-reservations/route"},resolvedPagePath:"C:\\Garden\\app\\api\\porteria\\daily-reservations\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:w}=p,y="/api/porteria/daily-reservations/route";function b(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},90455:(e,t,r)=>{r.d(t,{B$:()=>c,hm:()=>d,mk:()=>l,zB:()=>m});var a=r(41482),n=r.n(a),i=r(42023),o=r.n(i),s=r(9487);let u=process.env.JWT_SECRET||"dev-secret",c="gcp_token";async function d(){return 0===(await (0,s.getDb)()).data.users.length}async function m(e,t){let r=await (0,s.getDb)();if(0===r.data.users.length)return{token:n().sign({sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"},u,{expiresIn:"8h"}),user:{email:"setup@local",rol:"admin",nombre:"Administrador (setup)"}};let a=r.data.users.find(t=>t.email===e);return a&&await o().compare(t,a.passwordHash)?{token:n().sign({sub:a.id,rol:a.rol,nombre:a.nombre,email:a.email},u,{expiresIn:"8h"}),user:{email:a.email,rol:a.rol,nombre:a.nombre}}:null}async function l(e,t){if(0===(await (0,s.getDb)()).data.users.length)return{sub:"setup-admin",rol:"admin",nombre:"Administrador (setup)",email:"setup@local"};if(!e)return null;let r=e.cookies.get(c)?.value;if(!r)return null;try{let e=n().verify(r,u);if(t&&!t.includes(e.rol))return null;return e}catch{return null}}},9487:(e,t,r)=>{let a;r.r(t),r.d(t,{addDays:()=>E,calculateMemberDebt:()=>C,calculatePaidAmountForDebit:()=>A,computeQuote:()=>I,convertNoSocioToSocio:()=>m,endOfMonth:()=>F,formatCurrency:()=>q,getDb:()=>c,getMemberStatus:()=>T,hasReservationConflict:()=>x,nextCollectorCode:()=>l,nextCommissionId:()=>w,nextFamilyId:()=>g,nextFinancingId:()=>f,nextMemberCode:()=>d,nextMovementId:()=>D,nextPaymentId:()=>p,nextRefinancingId:()=>v,nextReservationId:()=>b,nextReservationPaymentId:()=>S,nextResourceId:()=>y,nextSubscriptionId:()=>h,startOfMonth:()=>P,toISODate:()=>M,yyyymm:()=>O});var n=r(26411),i=r(92048),o=r.n(i),s=r(55315),u=r.n(s);function c(){if(!a){let e=function(){let e=u().join(process.cwd(),"data");return o().existsSync(e)||o().mkdirSync(e,{recursive:!0}),u().join(e,"db.json")}();a=(0,n.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return a}async function d(){let e=await c();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function m(e){let t=await c(),r=t.data.members.findIndex(t=>t.id===e);if(-1===r)throw Error("Member not found");let a=t.data.members[r];if("NO SOCIO"!==a.subcategoria)throw Error("Member is not a no-socio");let n=await d();return t.data.members[r]={...a,codigo:n,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[r]}async function l(){let e=await c();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function p(){let e=await c();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function g(){let e=await c();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function f(){let e=await c();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function w(){let e=await c();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function y(){let e=await c();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function b(){let e=await c();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function S(){let e=await c();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function h(){let e=await c();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function D(){let e=await c();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function v(){let e=await c();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function I(e,t,r,a,n=0){let i=e.data.resources.find(e=>e.id===t),o=i?.precioBaseHora??0,s=new Date(r).getTime(),u=Math.max(1,Math.ceil((new Date(a).getTime()-s)/36e5)),c=o*u;return n>100&&(c=Math.round(1.05*c)),{horas:u,monto:c}}function x(e,t,r,a,n){let i=new Date(r).getTime(),o=new Date(a).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==n&&Math.max(new Date(e.start).getTime(),i)<Math.min(new Date(e.end).getTime(),o)&&"CANCELADO"!==e.status)}function q(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function A(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let r=0;for(let a of t)if(a.allocations&&Array.isArray(a.allocations))for(let t of a.allocations)t.debitId===e.id&&(r+=Number(t.amount||0));return r}function C(e,t){let a=0;for(let r of t)if(r.memberId===e.id&&"DEBIT"===r.tipo){if("REFINANCIADO"===r.status||"CANCELADO"===r.status)continue;let e=A(r,t),n=r.monto-e;n>0&&(a+=n)}let n=r(9487),i=0;try{for(let t of(n.getDb&&"function"==typeof n.getDb&&n.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))i+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,a-=i)}function T(e,t){return C(e,t)>0?"ATRASADO":"AL_DIA"}function M(e){let t="string"==typeof e?new Date(e):e,r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${r}-${a}-${n}`}function E(e,t){let r=new Date("string"==typeof e?e:e.getTime());return r.setDate(r.getDate()+t),r}function P(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function F(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function O(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},92906:(e,t,r)=>{r.d(t,{LJ:()=>i,tF:()=>n});let a={name:"America/Asuncion"};function n(){let e=new Date,t=Object.fromEntries(new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).formatToParts(e).map(e=>[e.type,e.value]));return new Date(parseInt(t.year),parseInt(t.month)-1,parseInt(t.day),parseInt(t.hour),parseInt(t.minute),parseInt(t.second))}function i(e){if(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${a}`}{let e=new Date;return new Intl.DateTimeFormat("en-CA",{timeZone:a.name,year:"numeric",month:"2-digit",day:"2-digit"}).format(e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,1482,4565],()=>r(25930));module.exports=a})();