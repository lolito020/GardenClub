"use strict";(()=>{var e={};e.id=8931,e.ids=[8931],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},25980:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>q,patchFetch:()=>A,requestAsyncStorage:()=>E,routeModule:()=>P,serverHooks:()=>I,staticGenerationAsyncStorage:()=>N});var r={};a.r(r),a.d(r,{GET:()=>C,OPTIONS:()=>x});var o=a(49303),n=a(88716),i=a(60670),s=a(87070),c=a(9487);let l={servicios:[],espacios:[],fechaInicio:"",fechaFin:"",busqueda:"",tipoBusqueda:"todos",estados:["ACTIVO"],ordenarPor:"fecha",orden:"desc"},u={"15_anos":{display:"Quincea\xf1era",icono:"\uD83C\uDF89",color:"text-pink-600"},boda:{display:"Boda",icono:"\uD83D\uDC92",color:"text-rose-600"},cumpleanos:{display:"Cumplea\xf1os",icono:"\uD83C\uDF82",color:"text-blue-600"},otros:{display:"Otro Evento",icono:"\uD83C\uDFAA",color:"text-purple-600"}},d={telefono:{display:"Tel\xe9fono",icono:"\uD83D\uDCDE",color:"text-blue-600"},whatsapp:{display:"WhatsApp",icono:"\uD83D\uDCF1",color:"text-green-600"},email:{display:"Email",icono:"\uD83D\uDCE7",color:"text-gray-600"},presencial:{display:"Presencial",icono:"\uD83C\uDFE2",color:"text-indigo-600"},otro:{display:"Otro",icono:"\uD83D\uDCCB",color:"text-gray-500"}},p=e=>new Date(e).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!1}),m=e=>new Date(e).toLocaleDateString("es-ES",{day:"2-digit",month:"short"}),f=e=>{if(!e.horaExtra||!e.cantidadHorasExtra)return e.end;let t=new Date(e.end);return t.setHours(t.getHours()+(e.cantidadHorasExtra||0)),t.toISOString()},h=(e,t=[],a=[])=>{let r=t.find(t=>t.id===e.resourceId),o=a.find(t=>t.id===e.resourceId);return o&&!r?{serviceName:o.nombre,spaceName:o.nombre,hasSpace:!1,service:void 0,venue:o}:r?{serviceName:r.nombre,spaceName:r.nombre,hasSpace:!1,service:r,venue:void 0}:{serviceName:"Servicio Desconocido",spaceName:"Espacio Desconocido",hasSpace:!1,service:void 0,venue:void 0}},g=e=>{if(!e.acontecimiento)return{tipo:null,tipoDisplay:"",persona:"",descripcion:"",icono:""};let t=u[e.acontecimiento],a="",r=e.otrosDescripcion;switch(e.acontecimiento){case"15_anos":a=e.quinceaneraFocusNombre||"";break;case"boda":a=e.noviosNombres||"";break;case"cumpleanos":a=e.cumpleaneroNombre||"";break;case"otros":a=e.otrosNombrePersona||""}return{tipo:e.acontecimiento,tipoDisplay:t.display,persona:a,descripcion:r,icono:t.icono}},w=e=>{let t=d[e.medioContacto];return{nombre:e.nombreContacto||"",telefono:"telefono"===e.medioContacto||"whatsapp"===e.medioContacto?e.contacto:void 0,email:"email"===e.medioContacto?e.contacto:void 0,medio:e.medioContacto,medioDisplay:t.display,contactoCompleto:e.contacto?`${t.display}: ${e.contacto}`:""}},v=(e,t=[],a=[])=>{let r=h(e,t,a),o=g(e),n=w(e);return{...e,serviceName:r.serviceName,spaceName:r.spaceName,hasSpace:r.hasSpace,eventoDisplay:o.tipo?`${o.icono} ${o.tipoDisplay}`:"",eventoPersona:o.persona,contactoDisplay:n.nombre,medioContactoDisplay:n.contactoCompleto,fechaDisplay:m(e.start),horarioDisplay:`${p(e.start)} - ${p(f(e))}`,duracionDisplay:e.horaExtra&&e.cantidadHorasExtra?`+${e.cantidadHorasExtra}h extra`:"Sin horas extra"}},y=(e,t,a=[],r=[])=>{let o=[...e];if(t.servicios.length>0&&(o=o.filter(e=>{let o=h(e,a,r);return t.servicios.some(e=>o.serviceName.toLowerCase().includes(e.toLowerCase())||o.service?.id===e)})),t.espacios.length>0&&(o=o.filter(e=>{let o=h(e,a,r);return t.espacios.some(e=>o.spaceName.toLowerCase().includes(e.toLowerCase())||o.venue?.id===e)})),t.fechaInicio){let e=new Date(t.fechaInicio);o=o.filter(t=>new Date(t.start)>=e)}if(t.fechaFin){let e=new Date(t.fechaFin);e.setHours(23,59,59,999),o=o.filter(t=>new Date(t.start)<=e)}if(t.estados.length>0&&(o=o.filter(e=>t.estados.includes(e.status))),t.busqueda.trim()){let e=t.busqueda.toLowerCase().trim();o=o.filter(o=>{switch(t.tipoBusqueda){case"evento":let n=g(o);return n.tipoDisplay.toLowerCase().includes(e)||n.persona.toLowerCase().includes(e);case"contacto":let i=w(o);return i.nombre.toLowerCase().includes(e)||i.telefono&&i.telefono.includes(e)||i.email&&i.email.toLowerCase().includes(e);case"nombre":return(o.nombreContacto||"").toLowerCase().includes(e);default:let s=h(o,a,r),c=g(o),l=w(o);return s.serviceName.toLowerCase().includes(e)||s.spaceName.toLowerCase().includes(e)||c.tipoDisplay.toLowerCase().includes(e)||c.persona.toLowerCase().includes(e)||l.nombre.toLowerCase().includes(e)||l.telefono&&l.telefono.includes(e)||o.notas&&o.notas.toLowerCase().includes(e)}})}return o},D=(e,t,a,r=[],o=[])=>[...e].sort((e,n)=>{let i=0;switch(t){case"fecha":i=new Date(e.start).getTime()-new Date(n.start).getTime();break;case"servicio":let s=h(e,r,o),c=h(n,r,o);i=s.serviceName.localeCompare(c.serviceName);break;case"contacto":i=(e.nombreContacto||"").localeCompare(n.nombreContacto||"");break;case"evento":let l=g(e),u=g(n);i=l.tipoDisplay.localeCompare(u.tipoDisplay);break;default:i=0}return"desc"===a?-i:i}),b=(e,t,a)=>{let r=e.length,o=(t-1)*a;return{reservations:e.slice(o,o+a),totalPages:Math.ceil(r/a),total:r}},S=e=>{let t=[];if(e.fechaInicio&&e.fechaFin){let a=new Date(e.fechaInicio),r=new Date(e.fechaFin);a>r&&t.push("La fecha de inicio no puede ser posterior a la fecha de fin"),Math.ceil(Math.abs(r.getTime()-a.getTime())/864e5)>365&&t.push("El rango de fechas no puede ser mayor a 1 a\xf1o")}return(e.porPagina<1||e.porPagina>100)&&t.push("La cantidad por p\xe1gina debe estar entre 1 y 100"),e.pagina<1&&t.push("La p\xe1gina debe ser mayor a 0"),t};async function C(e){try{let{searchParams:t}=new URL(e.url),a={servicios:t.get("servicios")?.split(",").filter(Boolean)||l.servicios,espacios:t.get("espacios")?.split(",").filter(Boolean)||l.espacios,fechaInicio:t.get("fechaInicio")||l.fechaInicio,fechaFin:t.get("fechaFin")||l.fechaFin,busqueda:t.get("busqueda")||l.busqueda,tipoBusqueda:t.get("tipoBusqueda")||l.tipoBusqueda,estados:t.get("estados")?.split(",")||l.estados,ordenarPor:t.get("ordenarPor")||l.ordenarPor,orden:t.get("orden")||l.orden,pagina:parseInt(t.get("pagina")||"1"),porPagina:parseInt(t.get("porPagina")||"20")},r=S(a);if(r.length>0)return s.NextResponse.json({error:"Filtros inv\xe1lidos",details:r},{status:400});let o=await (0,c.getDb)(),n=o.data.reservations||[],i=o.data.services||[],u=(o.data.resources||[]).map(e=>({id:e.id,nombre:e.nombre,descripcion:e.descripcion,activo:!0})),d=y(n,a,i,u);d=D(d,a.ordenarPor,a.orden,i,u);let{reservations:p,totalPages:m,total:f}=b(d,a.pagina,a.porPagina),h={reservas:p.map(e=>v(e,i,u)),total:f,pagina:a.pagina,totalPaginas:m,filtrosAplicados:a},g=new Headers;return g.set("X-Total-Count",f.toString()),g.set("X-Page",a.pagina.toString()),g.set("X-Total-Pages",m.toString()),g.set("X-Per-Page",a.porPagina.toString()),s.NextResponse.json(h,{status:200,headers:g})}catch(e){return console.error("❌ Error en /api/porteria/all-reservations:",e),s.NextResponse.json({error:"Error interno del servidor",message:e instanceof Error?e.message:"Error desconocido"},{status:500})}}async function x(e){try{let{searchParams:t}=new URL(e.url);if("true"===t.get("metadata")){let e=await (0,c.getDb)(),t=(e.data.services||[]).filter(e=>e.activo).map(e=>({id:e.id,nombre:e.nombre,tipo:e.tipo||"servicio"})),a=(e.data.resources||[]).map(e=>({id:e.id,nombre:e.nombre,descripcion:e.descripcion}));return s.NextResponse.json({servicios:t,espacios:a,estadosDisponibles:["ACTIVO","CONFIRMED","CONFIRMADO","PENDING","PENDIENTE","CULMINADO","CANCELADO","RESERVADO","FINALIZADO","HOLD"],tiposBusqueda:[{value:"todos",label:"Todos los campos"},{value:"evento",label:"Solo eventos"},{value:"contacto",label:"Solo contacto"},{value:"nombre",label:"Solo nombre"}],ordenamientos:[{value:"fecha",label:"Por fecha"},{value:"servicio",label:"Por servicio"},{value:"contacto",label:"Por contacto"},{value:"evento",label:"Por evento"}]})}return s.NextResponse.json({message:"Endpoint de metadatos de porter\xeda"})}catch(e){return console.error("❌ Error en metadata de /api/porteria/all-reservations:",e),s.NextResponse.json({error:"Error obteniendo metadatos",message:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let P=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/porteria/all-reservations/route",pathname:"/api/porteria/all-reservations",filename:"route",bundlePath:"app/api/porteria/all-reservations/route"},resolvedPagePath:"C:\\Garden\\app\\api\\porteria\\all-reservations\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:E,staticGenerationAsyncStorage:N,serverHooks:I}=P,q="/api/porteria/all-reservations/route";function A(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:N})}},9487:(e,t,a)=>{let r;a.r(t),a.d(t,{addDays:()=>A,calculateMemberDebt:()=>N,calculatePaidAmountForDebit:()=>E,computeQuote:()=>C,convertNoSocioToSocio:()=>d,endOfMonth:()=>O,formatCurrency:()=>P,getDb:()=>l,getMemberStatus:()=>I,hasReservationConflict:()=>x,nextCollectorCode:()=>p,nextCommissionId:()=>g,nextFamilyId:()=>f,nextFinancingId:()=>h,nextMemberCode:()=>u,nextMovementId:()=>b,nextPaymentId:()=>m,nextRefinancingId:()=>S,nextReservationId:()=>v,nextReservationPaymentId:()=>y,nextResourceId:()=>w,nextSubscriptionId:()=>D,startOfMonth:()=>F,toISODate:()=>q,yyyymm:()=>L});var o=a(26411),n=a(92048),i=a.n(n),s=a(55315),c=a.n(s);function l(){if(!r){let e=function(){let e=c().join(process.cwd(),"data");return i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();r=(0,o.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return r}async function u(){let e=await l();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function d(e){let t=await l(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let r=t.data.members[a];if("NO SOCIO"!==r.subcategoria)throw Error("Member is not a no-socio");let o=await u();return t.data.members[a]={...r,codigo:o,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function p(){let e=await l();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function m(){let e=await l();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function f(){let e=await l();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function h(){let e=await l();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function g(){let e=await l();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function w(){let e=await l();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function v(){let e=await l();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function y(){let e=await l();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function D(){let e=await l();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function b(){let e=await l();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function S(){let e=await l();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function C(e,t,a,r,o=0){let n=e.data.resources.find(e=>e.id===t),i=n?.precioBaseHora??0,s=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(r).getTime()-s)/36e5)),l=i*c;return o>100&&(l=Math.round(1.05*l)),{horas:c,monto:l}}function x(e,t,a,r,o){let n=new Date(a).getTime(),i=new Date(r).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==o&&Math.max(new Date(e.start).getTime(),n)<Math.min(new Date(e.end).getTime(),i)&&"CANCELADO"!==e.status)}function P(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function E(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let r of t)if(r.allocations&&Array.isArray(r.allocations))for(let t of r.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function N(e,t){let r=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=E(a,t),o=a.monto-e;o>0&&(r+=o)}let o=a(9487),n=0;try{for(let t of(o.getDb&&"function"==typeof o.getDb&&o.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))n+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,r-=n)}function I(e,t){return N(e,t)>0?"ATRASADO":"AL_DIA"}function q(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${a}-${r}-${o}`}function A(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function F(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function O(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function L(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},26411:(e,t,a)=>{a.d(t,{cW:()=>p}),a(87561);var r=a(93977),o=a(49411),n=a(41041);async function i(e,t,a){for(let r=0;r<t;r++)try{return await e()}catch(e){if(r<t-1)await new Promise(e=>setTimeout(e,a));else throw e}}class s{#e;#t;#a=!1;#r=null;#o=null;#n=null;#i=null;#s(e){return this.#i=e,this.#n||=new Promise((e,t)=>{this.#o=[e,t]}),new Promise((e,t)=>{this.#n?.then(e).catch(t)})}async #c(e){this.#a=!0;try{await (0,r.writeFile)(this.#t,e,"utf-8"),await i(async()=>{await (0,r.rename)(this.#t,this.#e)},10,100),this.#r?.[0]()}catch(e){throw e instanceof Error&&this.#r?.[1](e),e}finally{if(this.#a=!1,this.#r=this.#o,this.#o=this.#n=null,null!==this.#i){let e=this.#i;this.#i=null,await this.write(e)}}}constructor(e){this.#e=e,this.#t=function(e){let t=e instanceof URL?(0,n.fileURLToPath)(e):e.toString();return(0,o.join)((0,o.dirname)(t),`.${(0,o.basename)(t)}.tmp`)}(e)}async write(e){return this.#a?this.#s(e):this.#c(e)}}class c{#e;#l;constructor(e){this.#e=e,this.#l=new s(e)}async read(){let e;try{e=await (0,r.readFile)(this.#e,"utf-8")}catch(e){if("ENOENT"===e.code)return null;throw e}return e}write(e){return this.#l.write(e)}}class l{#u;#d;#p;constructor(e,{parse:t,stringify:a}){this.#u=new c(e),this.#d=t,this.#p=a}async read(){let e=await this.#u.read();return null===e?null:this.#d(e)}write(e){return this.#u.write(this.#p(e))}}class u extends l{constructor(e){super(e,{parse:JSON.parse,stringify:e=>JSON.stringify(e,null,2)})}}class d{adapter;data;constructor(e,t){(function(e,t){if(void 0===e)throw Error("lowdb: missing adapter");if(void 0===t)throw Error("lowdb: missing default data")})(e,t),this.adapter=e,this.data=t}async read(){let e=await this.adapter.read();e&&(this.data=e)}async write(){this.data&&await this.adapter.write(this.data)}async update(e){e(this.data),await this.write()}}async function p(e,t){let a=new d(new u(e),t);return await a.read(),a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(25980));module.exports=r})();