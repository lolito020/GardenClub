"use strict";(()=>{var e={};e.id=3239,e.ids=[3239],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},49411:e=>{e.exports=require("node:path")},41041:e=>{e.exports=require("node:url")},66773:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>p,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>l});var r={};a.r(r),a.d(r,{POST:()=>u});var n=a(49303),i=a(88716),s=a(60670),o=a(87070),c=a(9487);async function u(e){try{let t=await (0,c.getDb)();t.data.memberSubscriptions=t.data.memberSubscriptions??[],t.data.movements=t.data.movements??[],t.data.services=t.data.services??[];let a=(await e.json().catch(()=>({}))).memberId;if(!a)return o.NextResponse.json({ok:!1,error:"memberId requerido"},{status:400});let r=(0,c.toISODate)(new Date),n=new Date(r),i=new Map;for(let e of t.data.services)i.set(e.id,e);let s=t.data.memberSubscriptions.filter(e=>e.memberId===a&&"ACTIVE"===e.status&&e.autoDebit);if(0===s.length)return o.NextResponse.json({ok:!1,error:"No hay suscripciones activas con autod\xe9bito para este socio"},{status:400});let u=[];for(let e of s){let a=(0,c.yyyymm)(n),s=i.get(e.serviceId),o=s?.nombre||`Servicio ${e.serviceId}`,d="number"==typeof e.price?e.price:s?.precio??0,m=`${e.serviceId}:${a}`,l=t.data.movements.findIndex(t=>t.memberId===e.memberId&&"SUSCRIPCION"===t.origen&&t.refId===m);l>=0&&(console.log(`ðŸ—‘ï¸ Eliminando movimiento existente: ${m}`),t.data.movements.splice(l,1));let f={id:await (0,c.nextMovementId)(),memberId:e.memberId,fecha:r,concepto:`Cuota ${e.periodicity?.toLowerCase()||"mensual"} de ${o} (AU-TEST)`,tipo:"DEBIT",monto:Number(d)||0,origen:"SUSCRIPCION",refId:m,observaciones:`Cargo autom\xe1tico de prueba - ${a.slice(0,4)}-${a.slice(4,6)}`,status:"PENDIENTE",vencimiento:r};t.data.movements.push(f),u.push(f),console.log(`âœ… Movimiento de prueba creado: ${f.id} para ${m}`)}return await t.write(),o.NextResponse.json({ok:!0,createdCount:u.length,created:u.map(e=>({id:e.id,concepto:e.concepto,monto:e.monto,refId:e.refId}))})}catch(e){return console.error("Error en force-autodebits:",e),o.NextResponse.json({ok:!1,error:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/test/force-autodebits/route",pathname:"/api/test/force-autodebits",filename:"route",bundlePath:"app/api/test/force-autodebits/route"},resolvedPagePath:"C:\\Garden\\app\\api\\test\\force-autodebits\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:l,serverHooks:f}=d,p="/api/test/force-autodebits/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:l})}},9487:(e,t,a)=>{let r;a.r(t),a.d(t,{addDays:()=>$,calculateMemberDebt:()=>A,calculatePaidAmountForDebit:()=>P,computeQuote:()=>I,convertNoSocioToSocio:()=>m,endOfMonth:()=>N,formatCurrency:()=>q,getDb:()=>u,getMemberStatus:()=>C,hasReservationConflict:()=>D,nextCollectorCode:()=>l,nextCommissionId:()=>h,nextFamilyId:()=>p,nextFinancingId:()=>w,nextMemberCode:()=>d,nextMovementId:()=>v,nextPaymentId:()=>f,nextRefinancingId:()=>x,nextReservationId:()=>y,nextReservationPaymentId:()=>b,nextResourceId:()=>g,nextSubscriptionId:()=>S,startOfMonth:()=>M,toISODate:()=>E,yyyymm:()=>R});var n=a(26411),i=a(92048),s=a.n(i),o=a(55315),c=a.n(o);function u(){if(!r){let e=function(){let e=c().join(process.cwd(),"data");return s().existsSync(e)||s().mkdirSync(e,{recursive:!0}),c().join(e,"db.json")}();r=(0,n.cW)(e,{members:[],payments:[],services:[],users:[],collectors:[],families:[],financing:[],commissionPayments:[],movements:[],attachments:[],resources:[],reservations:[],reservationPayments:[],categories:[],memberSubscriptions:[],refinancings:[],sequences:{member:0,payment:0,collector:0,family:0,financing:0,commission:0,resource:0,reservation:0,reservationPayment:0,subscription:0,movement:0,refinancing:0}})}return r}async function d(){let e=await u();return e.data.sequences.member+=1,await e.write(),String(e.data.sequences.member)}async function m(e){let t=await u(),a=t.data.members.findIndex(t=>t.id===e);if(-1===a)throw Error("Member not found");let r=t.data.members[a];if("NO SOCIO"!==r.subcategoria)throw Error("Member is not a no-socio");let n=await d();return t.data.members[a]={...r,codigo:n,categoria:"Individual",subcategoria:"Socio"},await t.write(),t.data.members[a]}async function l(){let e=await u();return e.data.sequences.collector+=1,await e.write(),`COB-${String(e.data.sequences.collector).padStart(3,"0")}`}async function f(){let e=await u();return e.data.sequences.payment+=1,await e.write(),`PAY-${String(e.data.sequences.payment).padStart(6,"0")}`}async function p(){let e=await u();return e.data.sequences.family+=1,await e.write(),`FAM-${String(e.data.sequences.family).padStart(4,"0")}`}async function w(){let e=await u();return e.data.sequences.financing+=1,await e.write(),`FIN-${String(e.data.sequences.financing).padStart(4,"0")}`}async function h(){let e=await u();return e.data.sequences.commission+=1,await e.write(),`COM-${String(e.data.sequences.commission).padStart(6,"0")}`}async function g(){let e=await u();return e.data.sequences.resource+=1,await e.write(),`RESRC-${String(e.data.sequences.resource).padStart(4,"0")}`}async function y(){let e=await u();return e.data.sequences.reservation+=1,await e.write(),`RES-${String(e.data.sequences.reservation).padStart(6,"0")}`}async function b(){let e=await u();return e.data.sequences.reservationPayment+=1,await e.write(),`RESPAY-${String(e.data.sequences.reservationPayment).padStart(6,"0")}`}async function S(){let e=await u();return e.data.sequences.subscription+=1,await e.write(),`SUB-${String(e.data.sequences.subscription).padStart(6,"0")}`}async function v(){let e=await u();return e.data.sequences.movement+=1,await e.write(),`MOV-${String(e.data.sequences.movement).padStart(6,"0")}`}async function x(){let e=await u();return e.data.sequences.refinancing+=1,await e.write(),`REF-${String(e.data.sequences.refinancing).padStart(6,"0")}`}function I(e,t,a,r,n=0){let i=e.data.resources.find(e=>e.id===t),s=i?.precioBaseHora??0,o=new Date(a).getTime(),c=Math.max(1,Math.ceil((new Date(r).getTime()-o)/36e5)),u=s*c;return n>100&&(u=Math.round(1.05*u)),{horas:c,monto:u}}function D(e,t,a,r,n){let i=new Date(a).getTime(),s=new Date(r).getTime();return e.data.reservations.some(e=>e.resourceId===t&&e.id!==n&&Math.max(new Date(e.start).getTime(),i)<Math.min(new Date(e.end).getTime(),s)&&"CANCELADO"!==e.status)}function q(e){return new Intl.NumberFormat("es-PY",{style:"currency",currency:"PYG",minimumFractionDigits:0}).format(e)}function P(e,t){if(!e||"DEBIT"!==e.tipo)return 0;let a=0;for(let r of t)if(r.allocations&&Array.isArray(r.allocations))for(let t of r.allocations)t.debitId===e.id&&(a+=Number(t.amount||0));return a}function A(e,t){let r=0;for(let a of t)if(a.memberId===e.id&&"DEBIT"===a.tipo){if("REFINANCIADO"===a.status||"CANCELADO"===a.status)continue;let e=P(a,t),n=a.monto-e;n>0&&(r+=n)}let n=a(9487),i=0;try{for(let t of(n.getDb&&"function"==typeof n.getDb&&n.getDb().data?.refinancings||[]).filter(t=>t.memberId===e.id&&("ACTIVA"===t.status||"APROBADA"===t.status)))i+=Number(t.downPaymentAmount||0)}catch(e){}return Math.max(0,r-=i)}function C(e,t){return A(e,t)>0?"ATRASADO":"AL_DIA"}function E(e){let t="string"==typeof e?new Date(e):e,a=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${a}-${r}-${n}`}function $(e,t){let a=new Date("string"==typeof e?e:e.getTime());return a.setDate(a.getDate()+t),a}function M(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth(),1)}function N(e){let t="string"==typeof e?new Date(e):e;return new Date(t.getFullYear(),t.getMonth()+1,0)}function R(e){let t="string"==typeof e?new Date(e):e;return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}},26411:(e,t,a)=>{a.d(t,{cW:()=>l}),a(87561);var r=a(93977),n=a(49411),i=a(41041);async function s(e,t,a){for(let r=0;r<t;r++)try{return await e()}catch(e){if(r<t-1)await new Promise(e=>setTimeout(e,a));else throw e}}class o{#e;#t;#a=!1;#r=null;#n=null;#i=null;#s=null;#o(e){return this.#s=e,this.#i||=new Promise((e,t)=>{this.#n=[e,t]}),new Promise((e,t)=>{this.#i?.then(e).catch(t)})}async #c(e){this.#a=!0;try{await (0,r.writeFile)(this.#t,e,"utf-8"),await s(async()=>{await (0,r.rename)(this.#t,this.#e)},10,100),this.#r?.[0]()}catch(e){throw e instanceof Error&&this.#r?.[1](e),e}finally{if(this.#a=!1,this.#r=this.#n,this.#n=this.#i=null,null!==this.#s){let e=this.#s;this.#s=null,await this.write(e)}}}constructor(e){this.#e=e,this.#t=function(e){let t=e instanceof URL?(0,i.fileURLToPath)(e):e.toString();return(0,n.join)((0,n.dirname)(t),`.${(0,n.basename)(t)}.tmp`)}(e)}async write(e){return this.#a?this.#o(e):this.#c(e)}}class c{#e;#u;constructor(e){this.#e=e,this.#u=new o(e)}async read(){let e;try{e=await (0,r.readFile)(this.#e,"utf-8")}catch(e){if("ENOENT"===e.code)return null;throw e}return e}write(e){return this.#u.write(e)}}class u{#d;#m;#l;constructor(e,{parse:t,stringify:a}){this.#d=new c(e),this.#m=t,this.#l=a}async read(){let e=await this.#d.read();return null===e?null:this.#m(e)}write(e){return this.#d.write(this.#l(e))}}class d extends u{constructor(e){super(e,{parse:JSON.parse,stringify:e=>JSON.stringify(e,null,2)})}}class m{adapter;data;constructor(e,t){(function(e,t){if(void 0===e)throw Error("lowdb: missing adapter");if(void 0===t)throw Error("lowdb: missing default data")})(e,t),this.adapter=e,this.data=t}async read(){let e=await this.adapter.read();e&&(this.data=e)}async write(){this.data&&await this.adapter.write(this.data)}async update(e){e(this.data),await this.write()}}async function l(e,t){let a=new m(new d(e),t);return await a.read(),a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(66773));module.exports=r})();